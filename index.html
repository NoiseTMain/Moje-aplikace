<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Finanční Plánovač - Rozpočet a Investice</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --muted: #6b7280;
    --accent: #008080; /* Teal - Hlavní akcent */
    --accent2: #32cd32; /* Lime Green - Vedlejší akcent (pro příjmy/zisky) */
    --glass: rgba(255,255,255,0.6);
    --border: rgba(0,0,0,0.06);
    --text: #0f1724;
    --danger: #ef4444; /* Pro výdaje/ztráty */
  }
  [data-theme='dark']{
    --bg: #05060a;
    --card: rgba(20,25,30,0.6);
    --muted: #bfc8d2;
    --accent: #004d4d;
    --accent2: #1e8449;
    --glass: rgba(255,255,255,0.02);
    --border: rgba(255,255,255,0.06);
    --text: #fdf6e3;
    --danger: #922b2b;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{ height:100%; overflow-x: hidden; }
  body{
    font-family:Inter, "Segoe UI", Tahoma, sans-serif;
    background: linear-gradient(180deg,var(--bg), #eef2ff);
    color: var(--text);
    padding-bottom:40px;
    transition:all .25s;
    position:relative;
    overflow-x:hidden;
    touch-action: pan-y;
  }
  [data-theme='dark'] body{ background: radial-gradient(circle at 10% 10%, #071028 0%, #04050a 60%); }

  #starfield {
    position: fixed; left: 0; top: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 0; opacity: 0; transition: opacity 0.4s ease;
  }
  [data-theme='dark'] #starfield { opacity: 1; }

  header{
    position: relative; z-index: 5;
    background: linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    padding:20px 18px; display:flex; gap:12px; align-items:center; justify-content:space-between;
    border-bottom:14px solid rgba(230,230,230,0.9);
    border-image: url('https://www.transparenttextures.com/patterns/marble.png') 30 repeat;
    color: var(--text);
  }
  .title{ display:flex; flex-direction:column; z-index:5; }
  .title h1{ font-size:20px; margin-bottom:4px; }
  .title .sub{ font-size:12px; color:var(--muted) }

  .wrap{max-width:1100px;margin:16px auto;padding:0 18px; position:relative; z-index:5}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .controls{display:flex;gap:8px;align-items:center}

  .card{
    background:var(--card); border-radius:12px; padding:18px;
    box-shadow: 0 8px 30px rgba(15,23,42,0.06); border:1px solid var(--border);
    transition:transform .18s ease, box-shadow .18s ease, background .25s;
    backdrop-filter: blur(6px);
  }
  .card + .card{ margin-top:14px }
  .card:hover{ transform: translateY(-4px); box-shadow:0 18px 40px rgba(2,6,23,0.08) }

  .nav{ display:flex; gap:8px; background:transparent; padding:6px; border-radius:10px; }
  .nav button{ background:transparent; border:1px solid var(--border); padding:8px 12px; border-radius:8px; cursor:pointer; color:var(--muted); font-weight:700; }
  .nav button.active{ background:linear-gradient(90deg,var(--accent),#00a0a0); color:#fff; border-color:transparent; }

  .form-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
  input[type=text], input[type=date], input[type=number], select, textarea{
    padding:10px 12px; border-radius:8px; border:1px solid var(--border); min-width:150px; background:transparent; color:var(--text);
  }
  .btn{ display:inline-flex; gap:8px; align-items:center; padding:10px 14px; border-radius:10px; border:none; background:var(--accent); color:#fff; cursor:pointer; font-weight:700; }
  .btn.secondary{ background:transparent; color:var(--muted); border:1px solid var(--border); font-weight:700; }
  .btn.danger{ background:var(--danger); color:#fff; }
  .btn.income{ background:var(--accent2); color:#fff; }

  .table-wrap{ overflow:auto; margin-top:8px }
  table.main, table.settings{ width:100%; border-collapse:collapse; min-width:720px; background:var(--card); border-radius:8px; overflow:hidden; }
  table.main thead th, table.settings thead th{ text-align:left; padding:12px; background:var(--accent); color:#fff; font-weight:800; font-size:0.95em; }
  table.main tbody td, table.settings tbody td{ padding:12px; border-bottom:1px dashed rgba(0,0,0,0.06); vertical-align:middle; color:var(--text) }
  table.main tr:hover td, table.settings tr:hover td{ background:linear-gradient(90deg, rgba(0,0,0,0.02), transparent); }
  .badge{ display:inline-block; padding:6px 8px; border-radius:8px; color:#fff; font-weight:700; }
  .badge.danger{ background:var(--danger); }
  .badge.income{ background:var(--accent2); }
  .badge.info{ background:linear-gradient(90deg,#60a5fa,#93c5fd); } /* Pro Investiční cíl */

  .muted{ color:var(--muted); font-size:0.88em; }
  .stat-list{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-top:10px; }
  .stat-card{ padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent); border:1px solid var(--border) }
  .stat-card .value{ font-size:1.5em; font-weight:800; margin-top:4px; }
  .stat-card.income{ border-left:4px solid var(--accent2); }
  .stat-card.expense{ border-left:4px solid var(--danger); }
  .stat-card.balance{ border-left:4px solid var(--accent); }

  /* NOVÉ: Cíl - progress bar */
  .goal-item{ display:flex; flex-direction:column; gap:10px; padding:12px; 
    border-radius:10px; border:1px solid var(--border); background:linear-gradient(180deg,var(--card),transparent); 
    cursor:pointer; transition:background .18s; margin-top:8px;
  }
  .goal-item-header{
    display:flex; justify-content:space-between; align-items:center; gap:15px;
  }
  .goal-item-content{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
  }
  .goal-item-info{ flex-grow:1; }
  .goal-item:hover{ background:linear-gradient(180deg, rgba(255,255,255,0.8), transparent); }
  [data-theme='dark'] .goal-item:hover{ background:linear-gradient(180deg, rgba(255,255,255,0.05), transparent); }
  .progress-bar{ width:100%; background:#e0e0e0; border-radius:4px; margin-top:6px; }
  .progress-fill{ height:12px; background:var(--accent2); border-radius:4px; transition:width 0.4s ease-in-out; }

  /* MODAL */
  .modal-overlay{
    position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000;
    display:none; align-items:center; justify-content:center;
  }
  .modal-content{
    background:var(--card); border-radius:12px; padding:24px; max-width:500px; width:90%;
    box-shadow:0 24px 48px rgba(0,0,0,0.3); position:relative;
  }
  .modal-close{ position:absolute; top:10px; right:10px; background:transparent; border:0; font-size:24px; cursor:pointer; color:var(--muted); }
  .modal-header{ margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px; display:flex; align-items:center; }
  .modal-body > div{ margin-bottom:15px; }
  .modal-body label{ display:block; margin-bottom:5px; font-weight:700; color:var(--text); }
  .modal-footer{ margin-top:20px; text-align:right; display:flex; justify-content:space-between; }
  .modal-footer button{ margin-left:8px; }

  /* Historie styl */
  .history-list {
    display: flex; flex-direction: column; gap: 12px; margin-top: 15px;
  }
  .history-month-card {
    padding: 15px; border-radius: 10px; background: var(--card); border: 1px solid var(--border);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }
  .history-month-card h4 {
    margin-bottom: 10px; font-size: 1.1em; border-bottom: 1px solid var(--border); padding-bottom: 5px;
  }
  .history-stat-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;
  }
  .history-stat-grid > div {
      padding: 8px; border-radius: 6px; font-size: 0.9em;
      background: rgba(0,0,0,0.02);
  }
  .history-stat-grid > div strong { display: block; font-size: 1.1em; margin-top: 2px; }

  /* Kategorie tagy */
  .category-tag {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 10px; border-radius: 8px; font-weight: 700;
    cursor: pointer; transition: background 0.1s;
    font-size: 0.9em;
  }
  .category-tag.expense { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
  .category-tag.income { background: rgba(50, 205, 50, 0.1); color: var(--accent2); border: 1px solid rgba(50, 205, 50, 0.3); }
  .category-tag i.fa-times { margin-left: 4px; font-size: 0.8em; color: var(--muted); }
  .category-tag:hover { opacity: 0.85; }


  @media(max-width:820px){
    .topbar{ flex-direction:column; gap:8px; align-items:stretch }
    .form-row{ flex-direction:column; align-items:stretch }
    table.main, table.settings{ min-width:600px }
  }
</style>
</head>
<body data-theme="light">

<canvas id="starfield"></canvas>

<header>
  <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;width:100%">
    <div class="title">
      <h1><i class="fa fa-chart-line" style="color:var(--accent)"></i> Finanční Plánovač</h1>
      <div class="sub muted">Rozpočet, Investice a Přehled</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end">
      <div id="exchangeRateDisplay" class="muted" style="font-size:0.75em; margin-bottom:4px;">Kurz: 1 € ≈ 0.00 Kč</div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="currencySelect" onchange="changeCurrency()" style="padding:10px 12px; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text); font-weight:700;">
            <option value="CZK">Kč (CZK)</option>
            <option value="EUR">€ (EUR)</option>
        </select>
        <div id="todayShort" class="muted"></div>
        <button class="btn secondary" onclick="toggleTheme()" id="themeBtn"><i class="fa fa-moon"></i> Přepnout motiv</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <div class="topbar">
    <div class="nav card" role="navigation" aria-label="Sekce">
      <button class="active" data-section="budget" onclick="showSection(event)"><i class="fa fa-wallet"></i> Rozpočet</button>
      <button data-section="goals" onclick="showSection(event)"><i class="fa fa-bullseye"></i> Investiční cíle</button>
      <button data-section="stats" onclick="showSection(event)"><i class="fa fa-chart-pie"></i> Přehled</button>
      <button data-section="history" onclick="showSection(event)"><i class="fa fa-history"></i> Měsíční historie</button>
      <button data-section="settings" onclick="showSection(event)"><i class="fa fa-cogs"></i> Správa dat</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div class="card" style="display:flex;gap:8px;align-items:center">
        <div class="muted">Měsíc</div>
        <select id="monthSelect" onchange="applyMonthFilter()" style="min-width:180px"></select>
      </div>
      <div class="card" style="display:flex;gap:8px;align-items:center">
        <div class="muted">Filtr - Od</div>
        <input type="date" id="filterFrom" />
        <div class="muted">Do</div>
        <input type="date" id="filterTo" />
        <button class="btn secondary" onclick="applyFilter()"><i class="fa fa-search"></i> Aplikovat</button>
      </div>
    </div>
  </div>

  <section id="section-budget">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h2><i class="fa fa-plus-circle" style="color:var(--accent2)"></i> Záznam příjmu / výdaje</h2>
          <div class="muted">Zadejte detail transakce.</div>
        </div>
      </div>

      <div class="form-row" style="margin-top:14px">
        <input type="date" id="transactionDate" />
        <input type="text" id="transactionDesc" placeholder="Popis (např. 'Výplata' nebo 'Nájem')"/>
        <input type="number" id="transactionAmount" placeholder="Částka"/>
        <select id="transactionType">
          <option value="expense">Výdaj</option>
          <option value="income">Příjem</option>
        </select>
        <select id="transactionCategory">
            </select>
        <button class="btn" id="addTransactionBtn" onclick="addTransaction()"><i class="fa fa-plus-square"></i> Přidat transakci</button>
      </div>
    </div>

    <div class="card" id="transactionCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 class="muted"><i class="fa fa-table"></i> Historie transakcí</h3>
          <div class="muted">Transakce s celkovou bilancí pro filtrované období.</div>
        </div>
        <div class="muted">Celková bilance: <span id="totalBalance" style="font-weight:700">0 Kč</span></div>
      </div>

      <div class="table-wrap">
        <table class="main" id="mainTable">
          <thead>
            <tr><th>Datum</th><th>Popis</th><th>Typ</th><th>Částka</th><th>Akce</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="exports" style="justify-content:space-between">
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="exportCSV()"><i class="fa fa-file-csv"></i> Export CSV</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div class="muted">Řadit podle:</div>
          <select id="sortSelect" onchange="applySort()">
            <option value="date_desc">Datum (nejnovější)</option>
            <option value="date_asc">Datum (nejstarší)</option>
            <option value="amount_desc">Částka (největší)</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <section id="section-goals" style="display:none">
    <div class="card">
      <h2><i class="fa fa-hand-holding-usd"></i> Investiční a Spořicí Cíle</h2>
      <div class="muted">Zde můžete sledovat, kolik jste naspořili na jednotlivé cíle.</div>
      <div style="margin-top:12px">
        <div class="form-row">
            <input type="text" id="newGoalName" placeholder="Název cíle (např. 'Auto')" style="flex-grow:1"/>
            <input type="number" id="newGoalTarget" placeholder="Cílová částka"/>
            <input type="number" id="newGoalSaved" placeholder="Aktuálně naspořeno"/>
            <button class="btn" onclick="addGoal()"><i class="fa fa-plus-circle"></i> Přidat cíl</button>
        </div>
        <div id="goalsList" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <section id="section-stats" style="display:none">
    <div class="card">
      <h2><i class="fa fa-pie-chart"></i> Finanční Přehled</h2>
      <div class="muted">Statistiky a souhrn pro aktuální období filtru (výše).</div>

      <div class="stat-list" id="statCards">
        <div class="stat-card balance">
            <div class="muted">Zůstatek (Příjmy - Výdaje)</div>
            <div class="value" id="statBalance">0 Kč</div>
        </div>
        <div class="stat-card income">
            <div class="muted">Celkové Příjmy</div>
            <div class="value" id="statIncome">0 Kč</div>
        </div>
        <div class="stat-card expense">
            <div class="muted">Celkové Výdaje</div>
            <div class="value" id="statExpense">0 Kč</div>
        </div>
      </div>
      
      <h3 style="margin-top:20px"><i class="fa fa-tags"></i> Analýza kategorií</h3>
      <p class="muted">Kolik peněz šlo na jednotlivé kategorie (pro filtrované období).</p>
      
      <div id="categoryStats" class="stat-list" style="margin-top:12px">
          </div>
    </div>
  </section>
  
  <section id="section-history" style="display:none">
    <div class="card">
        <h2><i class="fa fa-history"></i> Měsíční Historie</h2>
        <div class="muted">Přehled příjmů, výdajů a bilance za posledních 12 měsíců.</div>
        <div id="historyList" class="history-list">
            </div>
    </div>
  </section>

  <section id="section-settings" style="display:none">
    <div class="card">
      <h2><i class="fa fa-wrench"></i> Nastavení kategorií</h2>
      <p class="muted">Zadejte vlastní kategorie pro lepší přehled. Klikněte pro úpravu.</p>
      
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;border:1px solid var(--border);padding:10px;border-radius:8px;background:var(--glass)">
        <select id="categoryType">
          <option value="expense">Výdajová</option>
          <option value="income">Příjmová</option>
        </select>
        <input type="text" id="newCategoryName" placeholder="Nová kategorie (např. 'Jídlo')" style="flex-grow:1"/>
        <button class="btn" onclick="addCategory()"><i class="fa fa-plus"></i> Přidat kategorii</button>
      </div>

      <div id="categoryList" style="margin-top:15px; display:flex; gap:8px; flex-wrap:wrap;">
        </div>

    </div>

    <div class="card">
      <h2><i class="fa fa-database"></i> Správa dat</h2>
      <p class="muted">Data se ukládají do prohlížeče (localStorage). Export, Import a Smazání.</p>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="exportAllJSON()"><i class="fa fa-download"></i> Exportovat data (JSON)</button>
        
        <input type="file" id="importJsonFile" accept=".json" style="display:none;" onchange="importAllJSON(event)">
        <button class="btn secondary" onclick="document.getElementById('importJsonFile').click()"><i class="fa fa-upload"></i> Nahrát JSON data</button>
        <button class="btn danger" onclick="clearAll()"><i class="fa fa-trash"></i> Vymazat data</button>
      </div>
    </div>
  </section>

</main>

<div id="transactionModal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal('transactionModal')"><i class="fa fa-times"></i></button>
    <div class="modal-header">
      <h3 id="modalTransactionTitle"><i class="fa fa-edit"></i> Úprava transakce</h3>
    </div>

    <div class="modal-body">
      <div>
        <label for="modalTDate">Datum:</label>
        <input type="date" id="modalTDate" style="width:100%"/>
      </div>
      <div>
        <label for="modalTDesc">Popis:</label>
        <input type="text" id="modalTDesc" style="width:100%"/>
      </div>
      <div>
        <label for="modalTAmount">Částka:</label>
        <input type="number" id="modalTAmount" style="width:100%"/>
      </div>
      <div>
        <label for="modalTType">Typ:</label>
        <select id="modalTType" style="width:100%">
          <option value="expense">Výdaj</option>
          <option value="income">Příjem</option>
        </select>
      </div>
      <div>
        <label for="modalTCategory">Kategorie:</label>
        <select id="modalTCategory" style="width:100%">
          </select>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn danger" id="modalDeleteBtn"><i class="fa fa-trash"></i> Smazat transakci</button>
      <button class="btn" onclick="saveTransactionProfile()"><i class="fa fa-save"></i> Uložit</button>
    </div>
  </div>
</div>

<div id="goalModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal('goalModal')"><i class="fa fa-times"></i></button>
      <div class="modal-header">
        <h3 id="modalGoalTitle"><i class="fa fa-bullseye"></i> Úprava cíle</h3>
      </div>
  
      <div class="modal-body">
        <div>
            <label for="modalGoalName">Název cíle:</label>
            <input type="text" id="modalGoalName" style="width:100%"/>
        </div>
        <div>
            <label for="modalGoalTarget">Cílová částka:</label>
            <input type="number" id="modalGoalTarget" style="width:100%"/>
        </div>
        <div>
            <label for="modalGoalSaved">Aktuálně naspořeno:</label>
            <input type="number" id="modalGoalSaved" style="width:100%" disabled/> </div>
        <div style="border-top:1px solid var(--border); padding-top:15px; margin-top:15px">
            <label for="modalInvestAmount">Přidat peníze (odečte se z rozpočtu):</label>
            <div style="display:flex; gap:8px">
                <input type="number" id="modalInvestAmount" placeholder="Částka k investování" style="flex-grow:1"/>
                <button class="btn income" onclick="addInvestmentFromModal()"><i class="fa fa-arrow-up"></i> Přidat investici</button>
            </div>
            <div class="muted" style="font-size:0.8em; margin-top:5px;">Datum transakce: <input type="date" id="modalInvestDate" style="width:150px; padding:5px 8px; font-size:0.9em;"/></div>
        </div>
      </div>
  
      <div class="modal-footer">
        <button class="btn danger" id="modalGoalDeleteBtn"><i class="fa fa-trash"></i> Smazat cíl</button>
        <button class="btn" onclick="saveGoalProfile()"><i class="fa fa-save"></i> Uložit změny cíle</button>
      </div>
    </div>
</div>


<script>
/* =========================
   Storage & data model
   ========================= */
const LS_TRANSACTIONS = 'finance_transactions_v1';
const LS_GOALS = 'finance_goals_v1';
const LS_CATEGORIES = 'finance_categories_v1'; 
const LS_CURRENCY = 'finance_currency_v1';
const LS_EXCHANGE_RATE = 'finance_exchange_rate_v1';

let store = {
  transactions: [], // [{id: 1, date: 'YYYY-MM-DD', desc: 'Popis', amount: 1000, type: 'income'|'expense', category: 'Kategorie'}]
  goals: [],        // [{id: 1, name: 'Auto', target: 500000, saved: 100000}]
  categories: [],   // Inicializuje se v loadStore na default
  currency: 'CZK',
  exchangeRate: 1, // 1 EUR = X CZK. Výchozí je 1, aby se CZK přepočítávaly 1:1, dokud se nenahrají EUR.
};

function loadStore(){
  try{
    const rawT = localStorage.getItem(LS_TRANSACTIONS);
    if(rawT) store.transactions = JSON.parse(rawT).map(t => ({
      ...t, 
      id: t.id || Math.random().toString(36).substring(2, 9) 
    }));
    else store.transactions = [];

    const rawG = localStorage.getItem(LS_GOALS);
    if(rawG) store.goals = JSON.parse(rawG).map(g => ({
        ...g, 
        id: g.id || Math.random().toString(36).substring(2, 9)
    }));
    else store.goals = [];

    const rawC = localStorage.getItem(LS_CATEGORIES);
    if(rawC) store.categories = JSON.parse(rawC);
    
    // Zajištění výchozích kategorií
    if(!store.categories || store.categories.length === 0) {
        store.categories = [
            { name: 'Nezadáno', type: 'expense' },
            { name: 'Jídlo', type: 'expense' },
            { name: 'Nájem/Bydlení', type: 'expense' },
            { name: 'Volný čas', type: 'expense' },
            { name: 'Investice', type: 'expense' },
            { name: 'Výplata', type: 'income' },
            { name: 'Bonus', type: 'income' },
        ];
    }
    
    // Načtení měny a kurzu
    const rawCurrency = localStorage.getItem(LS_CURRENCY);
    store.currency = rawCurrency || 'CZK';
    $('currencySelect').value = store.currency;
    
    const rawRate = localStorage.getItem(LS_EXCHANGE_RATE);
    store.exchangeRate = parseFloat(rawRate) || 1;


  }catch(e){
    console.warn('Load error',e);
    store.transactions = [];
    store.goals = [];
    store.categories = [ { name: 'Nezadáno', type: 'expense' } ];
    store.currency = 'CZK';
    store.exchangeRate = 1;
  }
}
function saveStore(){
  localStorage.setItem(LS_TRANSACTIONS, JSON.stringify(store.transactions));
  localStorage.setItem(LS_GOALS, JSON.stringify(store.goals));
  localStorage.setItem(LS_CATEGORIES, JSON.stringify(store.categories));
  localStorage.setItem(LS_CURRENCY, store.currency);
  localStorage.setItem(LS_EXCHANGE_RATE, store.exchangeRate.toFixed(4));
}

/* helpers */
function $(id){return document.getElementById(id)}
function closeModal(id){ $(id).style.display = 'none'; currentTransaction = null; currentGoal = null; }

function formatDate(d){ 
    if(!d) return '';
    const dt = new Date(d); 
    if(isNaN(dt.getTime())) { return d; }
    return dt.toLocaleDateString('cs-CZ'); 
}
function formatAmount(amount, currencyCode = store.currency){
    // Převod na cílovou měnu
    let finalAmount = amount;
    let code = 'CZK';
    let locale = 'cs-CZ';

    if (currencyCode === 'EUR') {
        finalAmount = amount / store.exchangeRate;
        code = 'EUR';
        locale = 'de-DE';
    } else { // CZK
        code = 'CZK';
        locale = 'cs-CZ';
    }

    return new Intl.NumberFormat(locale, { style: 'currency', currency: code }).format(finalAmount);
}
function todayShort(){ const n = new Date(); $('todayShort').textContent = n.toLocaleDateString('cs-CZ'); }


/* MĚNA A KURZ */
function fetchExchangeRate(){
    const simulatedRate = 24.50; 
    store.exchangeRate = simulatedRate;
    saveStore();
    $('exchangeRateDisplay').textContent = `Kurz: 1 € ≈ ${store.exchangeRate.toFixed(2)} Kč`;
}

function changeCurrency(){
    store.currency = $('currencySelect').value;
    saveStore();
    applyFilter();
    renderGoals();
    if(document.querySelector('.nav button[data-section="stats"]').classList.contains('active')) computeStats();
    if(document.querySelector('.nav button[data-section="history"]').classList.contains('active')) renderHistory();
}


/* nav */
function showSection(e){
  const btn = e.currentTarget;
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const sec = btn.getAttribute('data-section');
  document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
  $('section-'+sec).style.display = '';
  
  if(sec === 'stats') computeStats();
  if(sec === 'goals') renderGoals();
  if(sec === 'history') renderHistory();
  if(sec === 'settings') renderCategories(); // Ujistíme se, že se kategorie načtou
}

/* MĚSÍČNÍ FILTR */
function applyMonthFilter() {
    const selected = $('monthSelect').value;
    if (selected === 'custom') {
        $('filterFrom').disabled = false;
        $('filterTo').disabled = false;
    } else {
        const [year, month] = selected.split('-');
        const dateFrom = new Date(year, month - 1, 1);
        const dateTo = new Date(year, month, 0); 

        $('filterFrom').value = dateFrom.toISOString().slice(0, 10);
        $('filterTo').value = dateTo.toISOString().slice(0, 10);
        
        $('filterFrom').disabled = true;
        $('filterTo').disabled = true;
    }
    applyFilter();
}

function renderMonthOptions() {
    const select = $('monthSelect');
    select.innerHTML = '';

    const today = new Date();
    const options = [];
    const monthNames = ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen", "Červenec", "Srpen", "Září", "Říjen", "Listopad", "Prosinec"];

    for (let i = 0; i < 12; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const monthStr = month.toString().padStart(2, '0');
        const value = `${year}-${monthStr}`;
        const label = `${monthNames[date.getMonth()]} ${year}`;
        
        options.push({ value, label });
    }
    
    options.reverse().forEach((opt, index) => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        if (index === options.length - 1) { 
            option.selected = true;
        }
        select.appendChild(option);
    });

    const customOption = document.createElement('option');
    customOption.value = 'custom';
    customOption.textContent = 'Vlastní období...';
    select.appendChild(customOption);
    
    applyMonthFilter(); 
}


/* SETTINGS - Kategorie (OPRAVENO) */

// Nová pomocná funkce pro aktualizaci SELECT polí s kategoriemi
function updateCategorySelects() {
    const selects = [$('transactionCategory'), $('modalTCategory')];
    
    selects.forEach(select => {
        if (!select) return; // Pokud modal ještě není v DOM (např. modalTCategory)
        
        const currentSelected = select.value;
        const currentType = select.id === 'transactionCategory' ? $('transactionType').value : $('modalTType').value;
        
        select.innerHTML = '';
        
        const relevantCategories = store.categories.filter(c => c.type === currentType);

        if (relevantCategories.length === 0) {
            const opt = document.createElement('option');
            opt.value = 'Nezadáno';
            opt.textContent = 'Nezadáno';
            select.appendChild(opt);
            return;
        }

        relevantCategories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.textContent = c.name;
            select.appendChild(opt);
        });

        if (currentSelected && relevantCategories.some(c => c.name === currentSelected)) {
            select.value = currentSelected;
        } else {
            select.value = relevantCategories[0]?.name || 'Nezadáno';
        }
    });
}

// Při změně typu transakce se musí aktualizovat i kategorie
if ($('transactionType')) {
    $('transactionType').onchange = updateCategorySelects;
}

function renderCategories() {
    const list = $('categoryList');
    list.innerHTML = '';

    store.categories.forEach((cat, index) => {
        const tag = document.createElement('div');
        tag.className = `category-tag ${cat.type}`;
        tag.innerHTML = `${cat.name} <i class="fa fa-times" onclick="deleteCategory(${index}, event)"></i>`;
        list.appendChild(tag);
    });
    
    // Po vykreslení aktualizujeme i SELECTy
    updateCategorySelects();
}

function addCategory() {
    const name = $('newCategoryName').value.trim();
    const type = $('categoryType').value;

    if (!name) {
        alert('Zadejte prosím název kategorie.');
        return;
    }
    if (store.categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
        alert('Tato kategorie již existuje.');
        return;
    }
    
    store.categories.push({ name: name, type: type });
    saveStore();
    $('newCategoryName').value = '';
    renderCategories();
}

function deleteCategory(index, event) {
    event.stopPropagation(); // Zabraňuje spuštění jiné akce na tagu (která zde není)

    const catToDelete = store.categories[index];

    if (catToDelete.name === 'Investice' || catToDelete.name === 'Nezadáno' || catToDelete.name === 'Jídlo' || catToDelete.name === 'Výplata') {
        alert('Tuto výchozí/klíčovou kategorii nelze smazat.');
        return;
    }
    
    if (confirm(`Opravdu chcete smazat kategorii "${catToDelete.name}"? Všechny transakce s touto kategorií budou převedeny na "Nezadáno".`)) {
        // Přesun transakcí
        store.transactions.forEach(t => {
            if (t.category === catToDelete.name) {
                t.category = 'Nezadáno';
            }
        });

        store.categories.splice(index, 1);
        saveStore();
        renderCategories();
        applyFilter(); // Aktualizace tabulky transakcí
        computeStats(); // Aktualizace statistik
    }
}


/* BUDGET - přidání transakce */
function addTransaction(){
    const date = $('transactionDate').value;
    const desc = $('transactionDesc').value.trim();
    const amount = parseFloat($('transactionAmount').value);
    const type = $('transactionType').value;
    const category = $('transactionCategory').value; // Zde načteme vybranou kategorii
    
    if(!date || !desc || isNaN(amount) || amount <= 0){
        alert('Vyplňte prosím datum, popis a platnou kladnou částku.');
        return;
    }

    const newTransaction = {
        id: Math.random().toString(36).substring(2, 9),
        date: date,
        desc: desc,
        amount: amount, 
        type: type,
        category: category, 
    };

    store.transactions.push(newTransaction);
    saveStore();
    
    $('transactionDesc').value = '';
    $('transactionAmount').value = '';
    
    applyFilter();
    renderMonthOptions(); 
}

/* BUDGET - transakční modal */
let currentTransaction = null;

function openTransactionModal(id){
    currentTransaction = store.transactions.find(t => t.id === id);
    if(!currentTransaction) return;
    
    $('modalTransactionTitle').innerHTML = `<i class="fa fa-edit"></i> Úprava transakce: ${currentTransaction.desc}`;
    
    const updateCategorySelect = (currentType) => {
        const categorySelect = $('modalTCategory');
        categorySelect.innerHTML = '';
        // Filtr kategorií dle typu
        const relevantCategories = store.categories.filter(c => c.type === currentType);
        
        relevantCategories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.textContent = c.name;
            categorySelect.appendChild(opt);
        });
        
        // Nastavíme vybranou kategorii (pokud existuje a je v seznamu)
        if (relevantCategories.some(c => c.name === currentTransaction.category)) {
             categorySelect.value = currentTransaction.category;
        } else {
             categorySelect.value = relevantCategories[0]?.name || 'Nezadáno'; // Fallback
        }
    };

    $('modalTDate').value = currentTransaction.date;
    $('modalTDesc').value = currentTransaction.desc;
    $('modalTAmount').value = currentTransaction.amount; 
    $('modalTType').value = currentTransaction.type;
    updateCategorySelect(currentTransaction.type); 
    
    $('modalTType').onchange = (e) => {
        const newType = e.target.value;
        updateCategorySelect(newType);
    };

    $('modalDeleteBtn').onclick = () => deleteTransaction(currentTransaction.id);
    
    $('transactionModal').style.display = 'flex';
}

function saveTransactionProfile(){
    if(!currentTransaction) return;
    
    const newType = $('modalTType').value;
    const newCategory = $('modalTCategory').value;
    
    const amount = parseFloat($('modalTAmount').value); 
    if(!$('modalTDate').value || !$('modalTDesc').value.trim() || isNaN(amount) || amount <= 0){
        alert('Vyplňte prosím datum, popis a platnou kladnou částku.');
        return;
    }
    
    currentTransaction.date = $('modalTDate').value;
    currentTransaction.desc = $('modalTDesc').value.trim();
    currentTransaction.amount = amount;
    currentTransaction.type = newType;
    currentTransaction.category = newCategory;

    saveStore();
    closeModal('transactionModal');
    applyFilter();
    computeStats();
}

function deleteTransaction(id){
    if(confirm('Opravdu chcete tuto transakci smazat?')) {
        store.transactions = store.transactions.filter(t => t.id !== id);
        saveStore();
        closeModal('transactionModal');
        applyFilter();
        computeStats();
    }
}


/* GOALS - přidání investičního cíle (OPRAVENO) */

function addGoal(){
    const name = $('newGoalName').value.trim();
    const target = parseFloat($('newGoalTarget').value);
    const saved = parseFloat($('newGoalSaved').value) || 0; // Může být 0

    if(!name || isNaN(target) || target <= 0 || isNaN(saved) || saved < 0){
        alert('Vyplňte prosím název a platnou cílovou částku.');
        return;
    }
    
    const newGoal = {
        id: Math.random().toString(36).substring(2, 9),
        name: name,
        target: target,
        saved: saved,
    };

    store.goals.push(newGoal);
    saveStore();
    
    $('newGoalName').value = '';
    $('newGoalTarget').value = '';
    $('newGoalSaved').value = '';
    
    renderGoals();
}

function renderGoals(){
    const list = $('goalsList');
    list.innerHTML = '';

    if (store.goals.length === 0) {
        list.innerHTML = '<div class="muted" style="margin-top:10px">Zatím nebyly přidány žádné cíle.</div>';
        return;
    }

    store.goals.forEach(g => {
        const percentage = g.target > 0 ? ((g.saved / g.target) * 100).toFixed(1) : 0;
        const progressWidth = Math.min(100, parseFloat(percentage)) + '%';
        const isComplete = g.saved >= g.target;

        const item = document.createElement('div');
        item.className = 'goal-item';
        item.onclick = () => openGoalModal(g.id);
        
        item.innerHTML = `
            <div class="goal-item-header">
                <div style="font-size:1.1em; font-weight:700">${g.name} ${isComplete ? '<i class="fa fa-check-circle" style="color:var(--accent2)"></i>' : ''}</div>
                <div class="badge info">${percentage}%</div>
            </div>
            <div class="goal-item-content">
                <div class="goal-item-info">
                    <div class="muted">Naspořeno: <strong>${formatAmount(g.saved)}</strong> / Cíl: ${formatAmount(g.target)}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressWidth}; background:${isComplete ? 'var(--accent)' : 'var(--accent2)'}"></div>
                    </div>
                </div>
            </div>
        `;
        list.appendChild(item);
    });
}

let currentGoal = null;

function openGoalModal(id){
    currentGoal = store.goals.find(g => g.id === id);
    if(!currentGoal) return;
    
    $('modalGoalTitle').innerHTML = `<i class="fa fa-bullseye"></i> Úprava cíle: ${currentGoal.name}`;
    
    // Načtení dat cíle
    $('modalGoalName').value = currentGoal.name;
    $('modalGoalTarget').value = currentGoal.target;
    $('modalGoalSaved').value = currentGoal.saved;
    
    // Reset investičního pole
    $('modalInvestAmount').value = '';
    $('modalInvestDate').value = new Date().toISOString().slice(0, 10);

    $('modalGoalDeleteBtn').onclick = () => deleteGoal(currentGoal.id);
    
    $('goalModal').style.display = 'flex';
}

function saveGoalProfile(){
    if(!currentGoal) return;
    
    const target = parseFloat($('modalGoalTarget').value);
    
    if(!$('modalGoalName').value.trim() || isNaN(target) || target <= 0){
        alert('Vyplňte prosím název a platnou cílovou částku.');
        return;
    }
    
    currentGoal.name = $('modalGoalName').value.trim();
    currentGoal.target = target;
    // currentGoal.saved se aktualizuje jen přes investici, v modalu je pouze pro zobrazení (disabled)
    
    saveStore();
    closeModal('goalModal');
    renderGoals();
}

function deleteGoal(id){
    if(confirm('Opravdu chcete tento investiční cíl smazat?')) {
        store.goals = store.goals.filter(g => g.id !== id);
        saveStore();
        closeModal('goalModal');
        renderGoals();
    }
}

// NOVÁ KLÍČOVÁ FUNKCE: Přidání peněz do cíle + odepsání z rozpočtu
function addInvestmentToGoal(goalId, amount, date){
    const goal = store.goals.find(g => g.id === goalId);
    if(!goal || isNaN(amount) || amount <= 0) return false;

    // 1. Přičtení k naspořené částce cíle
    goal.saved += amount;

    // 2. Vytvoření výdajové transakce (Investice)
    const newTransaction = {
        id: Math.random().toString(36).substring(2, 9),
        date: date,
        desc: `Investice do cíle: ${goal.name}`,
        amount: amount, 
        type: 'expense',
        category: 'Investice',
    };

    store.transactions.push(newTransaction);
    
    saveStore();
    return true;
}

function addInvestmentFromModal(){
    if(!currentGoal) return;

    const amount = parseFloat($('modalInvestAmount').value);
    const date = $('modalInvestDate').value;

    if (isNaN(amount) || amount <= 0 || !date) {
        alert('Zadejte prosím platnou kladnou částku a datum pro investici.');
        return;
    }
    
    if (addInvestmentToGoal(currentGoal.id, amount, date)) {
        // Aktualizujeme zobrazenou naspořenou částku v modalu
        currentGoal = store.goals.find(g => g.id === currentGoal.id); // Znovu načteme aktuální data
        $('modalGoalSaved').value = currentGoal.saved;

        alert(`Investice ${formatAmount(amount)} byla přičtena k cíli "${currentGoal.name}" a odečtena z rozpočtu.`);

        // Vyčistíme pole a aktualizujeme zobrazení
        $('modalInvestAmount').value = '';
        renderGoals();
        applyFilter(); // Aktualizace rozpočtu a statistik
    } else {
        alert('Nepodařilo se přidat investici. Zkuste to znovu.');
    }
}


/* Ostatní funkce */
function renderTransactionTable(transactions){
    // ... (Zůstává stejné jako v původním kódu) ...
    currentTransactions = transactions;
    const tbody = $('tableBody');
    tbody.innerHTML = '';
    let totalBalance = 0;

    transactions.forEach((t) => {
        const tr = document.createElement('tr');
        const isExpense = t.type === 'expense';
        
        const amountDisplay = t.amount; 
        
        if(isExpense) totalBalance -= amountDisplay;
        else totalBalance += amountDisplay;

        const td1 = document.createElement('td'); td1.textContent = formatDate(t.date);
        const td2 = document.createElement('td'); 
        td2.innerHTML = `<strong>${t.desc}</strong><br><span class="muted">${t.category || 'Nezadáno'}</span>`;
        
        const td3 = document.createElement('td'); 
        const badge = document.createElement('span');
        badge.className = `badge ${isExpense ? 'danger' : 'income'}`;
        badge.textContent = isExpense ? 'Výdaj' : 'Příjem';
        td3.appendChild(badge);
        
        const td4 = document.createElement('td'); td4.textContent = formatAmount(t.amount); 
        td4.style.color = isExpense ? 'var(--danger)' : 'var(--accent2)';
        td4.style.fontWeight = '700';

        const td5 = document.createElement('td');
        const editBtn = document.createElement('button');
        editBtn.className = 'btn secondary action-small';
        editBtn.innerHTML = '<i class="fa fa-edit"></i> Upravit';
        editBtn.onclick = () => openTransactionModal(t.id);
        td5.appendChild(editBtn);

        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
        tbody.appendChild(tr);
    });
    
    const balanceEl = $('totalBalance');
    balanceEl.textContent = formatAmount(totalBalance); 
    balanceEl.style.color = totalBalance >= 0 ? 'var(--accent2)' : 'var(--danger)';
    
    document.querySelector('#mainTable thead th:nth-child(4)').textContent = 'Částka (' + store.currency + ')';
}

function applyFilter(){
    // ... (Zůstává stejné jako v původním kódu) ...
    const f = $('filterFrom').value ? new Date($('filterFrom').value) : new Date(0); 
    const t = $('filterTo').value ? new Date($('filterTo').value) : new Date();
    
    let filterToDate = t;
    if ($('filterTo').value) {
        filterToDate = new Date($('filterTo').value);
        filterToDate.setDate(filterToDate.getDate() + 1); 
        filterToDate.setSeconds(filterToDate.getSeconds() - 1); 
    } else {
        filterToDate.setDate(filterToDate.getDate() + 1);
        filterToDate.setSeconds(filterToDate.getSeconds() - 1);
    }
    
    let filtered = store.transactions.filter(t => {
        const date = new Date(t.date);
        return date >= f && date <= filterToDate;
    });
    
    const sel = $('sortSelect').value;
    if(sel==='date_desc'){ filtered.sort((a,b)=> new Date(b.date) - new Date(a.date)); }
    if(sel==='date_asc'){ filtered.sort((a,b)=> new Date(a.date) - new Date(b.date)); }
    if(sel==='amount_desc'){ 
        filtered.sort((a,b)=> {
            return b.amount - a.amount;
        });
    }
    
    renderTransactionTable(filtered);
    computeStats(); 
}

function applySort(){
    applyFilter(); 
}

function computeStats(){
    // ... (Zůstává stejné jako v původním kódu) ...
    const f = $('filterFrom').value ? new Date($('filterFrom').value) : new Date(0);
    const t = $('filterTo').value ? new Date($('filterTo').value) : new Date();
    
    let filterToDate = t;
    if ($('filterTo').value) {
        filterToDate = new Date($('filterTo').value);
        filterToDate.setDate(filterToDate.getDate() + 1); 
        filterToDate.setSeconds(filterToDate.getSeconds() - 1); 
    } else {
        filterToDate.setDate(filterToDate.getDate() + 1);
        filterToDate.setSeconds(filterToDate.getSeconds() - 1);
    }

    let totalIncome = 0;
    let totalExpense = 0;
    const categoryTotals = {}; 

    const filtered = store.transactions.filter(t => {
        const date = new Date(t.date);
        return date >= f && date <= filterToDate;
    });

    filtered.forEach(t => {
        if(t.type === 'income'){
            totalIncome += t.amount;
        } else {
            totalExpense += t.amount;
        }
        
        const catName = t.category || 'Nezadáno';
        if(!categoryTotals[catName]){
            categoryTotals[catName] = { amount: 0, type: t.type };
        }
        categoryTotals[catName].amount += t.amount;
    });

    const totalBalance = totalIncome - totalExpense;

    $('statBalance').textContent = formatAmount(totalBalance);
    $('statBalance').style.color = totalBalance >= 0 ? 'var(--accent2)' : 'var(--danger)';
    $('statIncome').textContent = formatAmount(totalIncome);
    $('statExpense').textContent = formatAmount(totalExpense);

    const catCont = $('categoryStats'); catCont.innerHTML = '';
    const sortedCats = Object.keys(categoryTotals).map(name => ({
        name,
        ...categoryTotals[name],
    })).sort((a, b) => b.amount - a.amount);
    
    sortedCats.forEach(cat => {
        const card = document.createElement('div'); 
        card.className=`stat-card ${cat.type === 'income' ? 'income' : 'expense'}`;
        
        const total = cat.type === 'income' ? totalIncome : totalExpense;
        const percentage = total > 0 ? ((cat.amount / total) * 100).toFixed(1) : 0;

        card.innerHTML = `
            <div class="muted">${cat.name} (${cat.type === 'income' ? 'Příjem' : 'Výdaj'})</div>
            <div class="value" style="color:${cat.type === 'income' ? 'var(--accent2)' : 'var(--danger)'}">${formatAmount(cat.amount)}</div>
            <div class="muted" style="margin-top:4px; font-weight:700">${percentage}% celku</div>
        `;
        catCont.appendChild(card);
    });
}

function renderHistory(){
    // ... (Zůstává stejné jako v původním kódu) ...
    const listCont = $('historyList');
    listCont.innerHTML = '';
    
    const today = new Date();
    const monthlyStats = {};

    for (let i = 0; i < 12; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = date.getMonth();
        const key = `${year}-${month.toString().padStart(2, '0')}`;
        const monthName = ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen", "Červenec", "Srpen", "Září", "Říjen", "Listopad", "Prosinec"][month];
        
        const dateFrom = new Date(year, month, 1);
        const dateTo = new Date(year, month + 1, 0); 
        dateTo.setHours(23, 59, 59, 999); 

        let totalIncome = 0;
        let totalExpense = 0;

        store.transactions.forEach(t => {
            const tDate = new Date(t.date);
            if (tDate >= dateFrom && tDate <= dateTo) {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            }
        });

        monthlyStats[key] = {
            name: `${monthName} ${year}`,
            income: totalIncome,
            expense: totalExpense,
            balance: totalIncome - totalExpense,
            year: year,
            month: month
        };
    }
    
    Object.keys(monthlyStats).sort().reverse().forEach(key => {
        const stats = monthlyStats[key];
        const card = document.createElement('div');
        card.className = 'history-month-card';
        
        const balanceColor = stats.balance >= 0 ? 'var(--accent2)' : 'var(--danger)';
        
        card.innerHTML = `
            <h4>${stats.name}</h4>
            <div class="history-stat-grid">
                <div>Příjmy: <strong style="color:var(--accent2)">${formatAmount(stats.income)}</strong></div>
                <div>Výdaje: <strong style="color:var(--danger)">${formatAmount(stats.expense)}</strong></div>
                <div>Bilance: <strong style="color:${balanceColor}">${formatAmount(stats.balance)}</strong></div>
            </div>
        `;
        listCont.appendChild(card);
    });
}


function clearAll(){
    if(confirm('POZOR: Opravdu chcete smazat VŠECHNA data (transakce, cíle, kategorie)? Tato akce je nevratná.')){
        localStorage.clear();
        alert('Všechna data byla smazána.');
        window.location.reload();
    }
}

function exportAllJSON(){
    const data = JSON.stringify(store, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'financni_planovac_export_' + new Date().toISOString().slice(0, 10) + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importAllJSON(event){
    const file = event.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedStore = JSON.parse(e.target.result);
            if(confirm('Opravdu chcete importovat tato data? PŘEPÍŠÍ AKTUÁLNÍ DATA.')){
                localStorage.setItem(LS_TRANSACTIONS, JSON.stringify(importedStore.transactions || []));
                localStorage.setItem(LS_GOALS, JSON.stringify(importedStore.goals || []));
                localStorage.setItem(LS_CATEGORIES, JSON.stringify(importedStore.categories || []));
                localStorage.setItem(LS_CURRENCY, importedStore.currency || 'CZK');
                localStorage.setItem(LS_EXCHANGE_RATE, importedStore.exchangeRate || 1);
                
                alert('Data úspěšně importována. Aplikace se obnoví.');
                window.location.reload();
            }
        } catch (error) {
            alert('Chyba při nahrávání souboru. Ujistěte se, že se jedná o platný JSON soubor. Chyba: ' + error.message);
        }
    };
    reader.readAsText(file);
}

function exportCSV() {
    let csv = 'Datum;Popis;Typ;Částka (' + store.currency + ');Kategorie\n';
    currentTransactions.forEach(t => {
        const amountDisplay = t.amount; // Ukládáme v CZK, ale pro export můžeme převést (zde ponecháno v CZK kvůli jednoduchosti, lze přepsat na formatAmount(t.amount, 'CZK').replace(/,/g, '') pro správné CSV)
        csv += `${t.date};"${t.desc.replace(/"/g, '""')}";${t.type === 'income' ? 'Příjem' : 'Výdaj'};${t.amount.toString().replace('.', ',')};${t.category || 'Nezadáno'}\n`;
    });

    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' }); // BOM pro správné kódování v Excelu
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'financni_planovac_export_transakci.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/* redraw / orchestrace */
function redrawAll(){
  loadStore();
  fetchExchangeRate(); 
  todayShort();
  
  renderMonthOptions(); 
  
  const now = new Date();
  if(!$('transactionDate').value) $('transactionDate').value = now.toISOString().slice(0,10);
  
  $('currencySelect').value = store.currency; 

  renderCategories(); // DŮLEŽITÉ: Načte kategorie i do SELECTu
  renderGoals(); 
  applyFilter(); 
  
  const currentTheme = document.body.getAttribute('data-theme') || 'light';
  updateThemeButton(currentTheme);
}


/* theme & starfield animation */
let starfieldCtx = null;
let stars = [];
let starAnimId = null;

const devicePixelRatio = window.devicePixelRatio || 1;

function initStarfield(){
  const c = document.getElementById('starfield');
  if (!c) return; 
  
  c.width = window.innerWidth * devicePixelRatio;
  c.height = window.innerHeight * devicePixelRatio;
  c.style.width = window.innerWidth + 'px';
  c.style.height = window.innerHeight + 'px';
  starfieldCtx = c.getContext('2d');
  starfieldCtx.scale(devicePixelRatio, devicePixelRatio);
  
  stars = [];
  const count = Math.round(window.innerWidth / 12);
  for(let i=0;i<count;i++){
    stars.push({
      x: Math.random() * window.innerWidth,
      y: Math.random() * window.innerHeight,
      r: Math.random() * 1.2 + 0.3,
      vx: (Math.random()-0.5)*0.02,
      vy: (Math.random()-0.5)*0.02,
      twinkle: Math.random()*1.5
    });
  }
}

function animateStarfield(time){
  if(!starfieldCtx) return;
  starfieldCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
  starfieldCtx.globalCompositeOperation = 'lighter';
  stars.forEach(s=>{
    s.x += s.vx * (1 + Math.sin(time/1000 + s.twinkle));
    s.y += s.vy * (1 + Math.cos(time/1100 + s.twinkle));
    if(s.x < 0) s.x = window.innerWidth;
    if(s.x > window.innerWidth) s.x = 0;
    if(s.y < 0) s.y = window.innerHeight;
    if(s.y > window.innerHeight) s.y = 0;
    const g = starfieldCtx.createRadialGradient(s.x, s.y, 0, s.x, s.y, s.r*6);
    g.addColorStop(0, 'rgba(255,255,255,0.95)');
    g.addColorStop(0.2, 'rgba(255,255,255,0.6)');
    g.addColorStop(1, 'rgba(255,255,255,0.0)');
    starfieldCtx.fillStyle = g;
    starfieldCtx.beginPath();
    starfieldCtx.arc(s.x, s.y, s.r*3, 0, Math.PI*2);
    starfieldCtx.fill();
  });
  starAnimId = requestAnimationFrame(animateStarfield);
}
function startStarfield(){ 
    if(!starfieldCtx) initStarfield(); 
    if(!starAnimId) starAnimId = requestAnimationFrame(animateStarfield); 
}
function stopStarfield(){ 
    if(starAnimId){ 
        cancelAnimationFrame(starAnimId); 
        starAnimId = null; 
        const c = document.getElementById('starfield'); 
        if(c && starfieldCtx){ 
            starfieldCtx.clearRect(0,0,c.width,c.height); 
        } 
    } 
}

function toggleTheme(){
  const body = document.body;
  const t = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
  body.setAttribute('data-theme', t);
  updateThemeButton(t);
  if(t === 'dark'){ 
    startStarfield(); 
  } else { 
    stopStarfield(); 
  }
}

function updateThemeButton(theme){
    const btn = $('themeBtn');
    if(!btn) return;
    if(theme === 'dark'){
        btn.innerHTML = '<i class="fa fa-sun"></i> Přepnout motiv';
    } else {
        btn.innerHTML = '<i class="fa fa-moon"></i> Přepnout motiv';
    }
}

window.addEventListener('resize', ()=>{ 
    if(document.body.getAttribute('data-theme')==='dark'){
        initStarfield(); 
    }
});

window.addEventListener('mousemove',(e)=>{
  if(!stars || stars.length===0 || document.body.getAttribute('data-theme') === 'light') return; 
  const cx = e.clientX / window.innerWidth - 0.5;
  const cy = e.clientY / window.innerHeight - 0.5;
  stars.forEach((s,i)=>{
    s.x += cx * 0.6 * (i%3===0 ? 0.6 : 0.2);
    s.y += cy * 0.6 * (i%3===0 ? 0.6 : 0.2);
  });
});

/* init */
(function init(){
  redrawAll();
  
  const currentTheme = document.body.getAttribute('data-theme') || 'light';
  updateThemeButton(currentTheme);
  if(currentTheme === 'dark') {
      initStarfield();
      startStarfield(); 
  }
})();
</script>

</body>
</html>
