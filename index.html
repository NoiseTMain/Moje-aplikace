<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Amex Style Portál - Osobní Rozpočet a Karty</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">


<style>
  /* ========================================================
     AMERICAN EXPRESS THEME VARIABLES - Prémiový, čistý vzhled
     ======================================================== */
  :root{
    --bg: #f5f5f7; /* Velmi světle šedé pozadí - jako čistá aplikace */
    --card: #ffffff; /* Bílé karty */
    --muted: #6b7280; /* Tlumená šedá */
    --accent: #007bc1; /* Ikonická Amex Modrá */
    --accent-light: #4c96d7;
    --accent2: #16a34a; /* Zelená pro zisky */
    --glass: rgba(255,255,255,0.85);
    --border: rgba(0,0,0,0.08); /* Jemný, ale viditelný border */
    --text: #1f2937; /* Tmavá textura */
    --danger: #ef4444; /* Červená pro výdaje */
    --shadow: 0 4px 12px rgba(0,0,0,0.08); /* Jemný, ale znatelný stín */
    --radius: 12px; /* Mírné zaoblení */
    --amex-gold: linear-gradient(135deg, #e3c08f, #a08151); /* Zlatý gradient */
    --amex-platinum: linear-gradient(135deg, #afb1b5, #7d7e82); /* Platinový gradient */
    /* Přidáno pro Visa/MasterCard simulaci */
    --visa-blue: linear-gradient(135deg, #1A479F, #196FB3); 
    --mastercard-red: linear-gradient(135deg, #E8291A, #C9000C);
  }
  /* ÚPRAVA TMAVÉHO REŽIMU */
  [data-theme='dark']{
    --bg: #111827; /* Tmavě modré/šedé pozadí */
    --card: #1f2937; /* Tmavě modré/šedé karty */
    --muted: #9ca3af;
    --accent: #4c96d7; /* Světlejší modrá pro lepší viditelnost */
    --accent-light: #007bc1;
    --accent2: #4ade80;
    --glass: rgba(31, 41, 55, 0.95);
    --border: rgba(255,255,255,0.15); /* Světlejší border v dark modu */
    --text: #f9fafb;
    --danger: #f87171;
    --shadow: 0 4px 12px rgba(0,0,0,0.5); 
    --amex-gold: linear-gradient(135deg, #c3a06f, #806131); 
    --amex-platinum: linear-gradient(135deg, #8f9195, #5d5e62);
  }

  /* RESET A ZÁKLADNÍ TYPOGRAFIE */
  *{box-sizing:border-box;margin:0;padding:0}
  
  /* ========================================================
     OPRAVA 3: FIXNÍ VÝŠKA PRO APP-STYLE & OBSAH SE SCROLLEM
     ======================================================== */
  html, body {
    height: 100%;
    overflow: hidden; /* Zamezí se globální scroll - Scrolluje se jen wrap */
  }
  body{
    font-family: 'Inter', "Segoe UI", Tahoma, sans-serif;
    background: var(--bg); 
    color: var(--text);
    transition:all .3s ease-in-out; 
    position:relative;
  }
  
  /* Záhlaví - Fixní a čisté */
  header{
    /* Důležité: 'position: sticky' byl nahrazen 'position: fixed' pro dokonalé ukotvení nahoře, 
       jelikož body nemá scroll, sticky by nefungovalo správně */
    position: fixed; top: 0; left:0; width:100%; z-index: 100; 
    background: var(--card); 
    border-bottom: 1px solid var(--border); 
    padding:16px 18px; 
    display:flex; align-items:center; justify-content:space-between;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05); 
    color: var(--text);
    /* Přidáno: výška headeru */
    height: 62px;
  }
  @media(max-width:768px){ 
    header{ height: 56px; }
  }
  .title h1{ font-size:20px; margin-bottom:2px; font-weight:900; }
  .title .sub{ font-size:12px; color:var(--muted); font-weight:500; }

  /* ========================================================
     Kontejner a Karty (Zbývající výška pro scroll)
     ======================================================== */
  .wrap{
    max-width:1200px;
    margin:0 auto;
    padding:0 12px; 
    position:relative; 
    z-index:5;
    /* Důležité: odečtení VÝŠKY HEADERU a VÝŠKY FOOTER NAV */
    height: calc(100% - 62px - 75px); 
    overflow-y: auto; /* Povolí scroll POUZE v rámci obsahu sekce */
    scroll-behavior: smooth;
    /* Důležité: Odsazení od fixního headeru */
    margin-top: 62px;
    padding-top: 20px; /* Přidáno polstrování pro obsah */
  }
  @media(max-width:768px){ 
    .wrap{ 
        height: calc(100% - 56px - 75px); /* Menší header na mobilu */
        margin-top: 56px;
        padding-top: 16px; 
    }
  }
  
  /* Jednotlivé sekce aplikace */
  main section {
      padding-bottom: 20px; /* Polstrování na konci sekce pro lepší vzhled */
  }
  
  /* ... (OSTATNÍ CSS ZŮSTÁVÁ STEJNÉ) ... */
  
  .card{
    background:var(--card); 
    border-radius:var(--radius); 
    padding:20px;
    box-shadow: var(--shadow); 
    border:1px solid var(--border);
    transition: transform .25s ease, box-shadow .25s ease, background .3s;
    overflow: hidden; 
  }
  .card + .card{ margin-top:16px }
  .topbar{ margin-bottom: 20px; padding: 0;}
  .filter-bar{
      display:flex; gap:10px; align-items:flex-end; 
      padding:15px; border-radius:var(--radius); 
      background:var(--card); border:1px solid var(--border);
      box-shadow: var(--shadow);
  }
  .filter-item{ display: flex; flex-direction: column; gap: 4px; }
  .filter-item input, .filter-item select { margin-right: 5px; }

  /* Formuláře a Tlačítka - Čistý bankovní styl */
  input[type=text], input[type=date], input[type=number], select, textarea{
    padding:12px 14px; 
    border-radius:8px; 
    border:1px solid var(--border); 
    min-width:180px; 
    background:var(--bg); 
    color:var(--text);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
    flex-grow: 1; 
  }
  .form-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
  .btn{ 
    padding:12px 18px; 
    border:none;
    border-radius:8px; 
    background:var(--accent); 
    color:#fff;
    font-weight:700; 
    transition: background .2s, transform .1s, box-shadow .2s;
    box-shadow: 0 2px 6px rgba(0,123,255,0.25);
    cursor:pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap; /* Tlačítka se nezalomí */
  }
  .btn:hover{ background: var(--accent-light); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,123,255,0.35); }
  .btn.danger { 
    background: var(--danger); 
    box-shadow: 0 2px 6px rgba(239,68,68,0.25);
  }
  .btn.danger:hover {
    background: #dc2626;
    box-shadow: 0 4px 8px rgba(239,68,68,0.35);
  }
  .btn.secondary {
    background: var(--bg);
    color: var(--text);
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .btn.secondary:hover {
    background: var(--border);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }


  /* Tabulka */
  table.main{ width:100%; border-collapse: collapse; margin-top: 15px; }
  table.main th, table.main td{ padding: 12px; border-bottom: 1px solid var(--border); }
  table.main thead th{ 
    text-align:left;
    background:var(--accent); 
    color:#fff; 
    font-weight:700; 
    font-size:0.9em; 
    border-right:none; 
    /* Fixní hlavička v sekci - funguje díky scrollu na .wrap */
    position: sticky; top: 0; z-index: 10; 
  }
  table.main tbody tr:last-child td { border-bottom: none; }
  .action-small { 
    padding: 8px 12px; 
    font-size: 0.8em; 
    min-width: unset;
    height: 38px;
  }
  
  /* MODAL STYLE */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }
  .modal-content {
    background: var(--card);
    padding: 25px;
    border-radius: var(--radius);
    max-width: 500px;
    width: 90%;
    box-shadow: var(--shadow);
    max-height: 90vh;
    overflow-y: auto;
  }

  /* Stat karty pro Analýzu */
  .stat-list{
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  .stat-card{
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg);
  }
  .stat-card .value{
    font-size: 1.5em;
    font-weight: 800;
    margin-top: 5px;
  }
  
  /* ========================================================
     FIXNÍ SPODNÍ NAVIGACE (App Style)
     ======================================================== */
  .footer-nav{
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 75px; /* Vyšší pro lepší dotyk */
    background: var(--card);
    border-top: 1px solid var(--border);
    box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
    display: flex;
    justify-content: space-around;
    padding: 8px 0;
    z-index: 1000; /* Vždy nahoře */
  }
  /* Styl navigačních tlačítek a ikon */
  .footer-nav button{
    /* ... (CSS pro buttony zůstalo stejné) ... */
    background: none;
    border: none;
    color: var(--muted);
    font-size: 11px;
    font-weight: 600;
    padding: 6px 10px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: all .2s;
    min-width: 60px;
    max-width: 80px;
    cursor: pointer;
  }
  .footer-nav button i{ font-size: 20px; }
  .footer-nav button.active{
    color: var(--accent);
    /* Animace podtržení pro aktivní tlačítko */
    box-shadow: inset 0 -3px 0 0 var(--accent); 
  }
  [data-theme='dark'] .footer-nav button.active{
    background: none;
  }
  
  /* ========================================================
     KARTA VZHLED - American Express a další (OPRAVA BOD 2)
     ======================================================== */
  .card-container-wrap {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
  }
  .amex-card {
      position: relative;
      width: 100%;
      height: 190px; 
      border-radius: 12px;
      padding: 20px;
      color: #fff;
      font-family: 'Inter', sans-serif; 
      cursor: default;
      box-shadow: 0 10px 20px rgba(0,0,0,0.25);
      transition: all 0.3s ease;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      /* Defaultní styl - nahrazen třídami pro typ */
      background: var(--amex-platinum); 
  }
  
  /* Specifické styly pro typy karet */
  .amex-gold-card { background: var(--amex-gold); }
  .amex-platinum-card { background: var(--amex-platinum); }
  .visa-card { background: var(--visa-blue); }
  .mastercard-card { background: var(--mastercard-red); }

  .amex-card-header{
      display:flex; justify-content:space-between; align-items:center;
  }
  .card-issuer {
      font-size: 10px; opacity: 0.8; font-weight: 500;
  }
  .amex-logo {
      font-size: 22px;
      font-weight: 900;
      color: #ffffff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
      font-family: 'Inter', sans-serif;
  }
  .card-chip {
      width: 40px;
      height: 30px;
      background: linear-gradient(to right, #e0e0e0, #ffffff);
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      margin-top: 15px;
  }
  .card-number {
      font-size: 19px;
      letter-spacing: 2px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
      opacity: 0.95;
      font-weight: 600;
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .card-copy-btn{
      background: none; border:none; color: rgba(255,255,255,0.7);
      cursor:pointer; transition: color .2s;
      padding: 5px; /* Pro lepší dotyk */
  }
  .card-copy-btn:hover{ color: #fff; }

  .card-details {
      display:flex; justify-content:space-between; align-items:flex-end;
      margin-top: 10px;
  }
  .card-owner-info div {
      font-size: 10px; line-height: 1.2; opacity: 0.8;
  }
  .card-owner {
      font-weight: 700;
      font-size: 14px;
      text-transform: uppercase;
      margin-top: 2px;
  }
  .card-valid-thru {
      text-align: right;
      font-size: 10px;
      line-height: 1.2;
      opacity: 0.8;
  }
  .card-valid-thru strong {
      font-size: 12px;
      display: block;
  }
  .card-copy-status {
      position: fixed; /* Fixní zobrazení notifikace */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      font-size: 16px;
      font-weight: 600;
      z-index: 9999;
  }
  .card-copy-status.show { opacity: 1; }
  
  /* Oprava pro mobilní zobrazení */
  @media(max-width:600px){
      .filter-bar{ flex-direction: column; align-items: stretch; }
      .filter-item{ width:100%; flex-direction:row; align-items:center; }
      .filter-item div.muted{ flex-basis: 40px; }
      .filter-item input, .filter-item select{ min-width:unset; }
      .filter-item .btn { flex-basis: 100%; margin-top: 10px; }
  }
  @media(max-width:350px){
      .footer-nav button span { display:none; }
      .footer-nav button i { font-size: 24px; }
  }
  
  /* Styl pro cíl (Goals) */
  .goal-item.card{
      transition: all 0.2s;
  }
  .goal-item.card:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }

  /* Nový styl pro oranžový indikátor trvalých plateb */
  .upcoming-indicator {
    background: #ff9900; /* Oranžová barva pro upozornění */
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.8em;
    margin-left: 8px;
    font-weight: 800;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  .recurring-payment-card {
      border-left: 5px solid #ff9900;
  }
  .upcoming-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  .upcoming-item:last-child { border-bottom: none; }
  .unpaid-bill {
      background: var(--bg);
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px dashed #ff9900;
  }

</style>
</head>
<body data-theme="light">

<header>
  <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;width:100%">
    <div class="title">
      <h1><i class="fa fa-university" style="color:var(--accent)"></i> <span style="color:var(--accent)">E</span>-Portál</h1>
      <div class="sub muted">adam</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end">
      <div id="exchangeRateDisplay" class="muted" style="font-size:0.8em; margin-bottom:4px; font-weight:600;">Kurz: 1 € ≈ 0.00 Kč</div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="currencySelect" onchange="changeCurrency()" style="padding:10px; border-radius:8px; font-weight:700;">
            <option value="CZK">Kč (CZK)</option>
            <option value="EUR">€ (EUR)</option>
        </select>
        <button class="btn secondary" onclick="toggleTheme()" id="themeBtn"><i class="fa fa-moon"></i></button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <section id="section-budget">
    <div class="topbar">
      <div class="filter-bar">
        <div class="filter-item">
          <div class="muted">Období:</div>
          <select id="monthSelect" onchange="applyMonthFilter()" style="flex-grow:0; min-width:160px"></select>
        </div>
        <div class="filter-item" style="flex-grow:1; align-items:center;">
          <div class="muted" style="white-space:nowrap;">Od:</div>
          <input type="date" id="filterFrom" style="min-width:120px" disabled/>
          <div class="muted" style="white-space:nowrap;">Do:</div>
          <input type="date" id="filterTo" style="min-width:120px" disabled/>
          <button class="btn secondary" onclick="applyFilter()" style="padding:12px 14px;"><i class="fa fa-filter"></i> Filtr</button>
        </div>
      </div>
    </div>
    
    <div class="card" style="margin-bottom: 20px;">
      <h2><i class="fa fa-exchange-alt" style="color:var(--accent)"></i> Nová Transakce</h2>
      <div class="muted">Zadejte detail platby nebo příjmu.</div>

      <div class="form-row" style="margin-top:20px">
        <input type="date" id="transactionDate" style="flex-basis: 120px;"/>
        <input type="text" id="transactionDesc" placeholder="Popis (např. 'Příchozí platba' nebo 'Lidl')"/>
        <input type="number" id="transactionAmount" placeholder="Částka (např. 1500)"/>
        <select id="transactionType">
          <option value="expense">Platba / Výdaj</option>
          <option value="income">Přijatá platba / Příjem</option>
        </select>
        <select id="transactionCategory" style="flex-basis: 150px;"></select>
        <button class="btn" id="addTransactionBtn" onclick="addTransaction()" style="flex-basis: auto;"><i class="fa fa-plus-square"></i> Provedení</button>
      </div>
    </div>

    <div class="card" id="transactionCard">
      <div style="display:flex;justify-content:space-between;align-items:center; flex-wrap:wrap; gap:10px;">
        <div>
          <h3 class="muted"><i class="fa fa-receipt"></i> Detailní Přehled Transakcí</h3>
          <div class="muted">Všechny platby a pohyby pro vybrané období.</div>
        </div>
        <div class="muted" style="font-size:1.1em;">
          Celkový **Zůstatek**: <span id="totalBalance" style="font-weight:900; font-size:1.3em;">0 Kč</span>
          <span id="upcomingPaymentsSum" class="upcoming-indicator" style="display:none;">
            <i class="fa fa-exclamation-triangle"></i> K úhradě: <span id="upcomingAmountText"></span>
          </span>
        </div>
      </div>

      <div id="upcomingPaymentsDetail" class="unpaid-bill" style="display:none; margin-top: 15px;">
        <p class="muted" style="padding:10px 12px; border-bottom:1px solid var(--border);">
            <i class="fa fa-calendar-alt" style="color:#ff9900;"></i> **Trvalé platby k úhradě** v tomto období:
        </p>
        <div id="upcomingPaymentsList"></div>
      </div>
      
      <div class="table-wrap" style="overflow-x:auto;">
        <table class="main" id="mainTable">
          <thead>
            <tr><th>Datum</th><th>Popis a Kategorie</th><th>Typ</th><th>Částka</th><th>Akce</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="exports" style="display:flex;justify-content:space-between; margin-top:15px; flex-wrap:wrap; gap:10px;">
        <div style="display:flex;gap:8px">
          <button class="btn secondary" onclick="exportCSV()"><i class="fa fa-file-csv"></i> Export CSV</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div class="muted">Řadit:</div>
          <select id="sortSelect" onchange="applySort()">
            <option value="date_desc">Datum (nejnovější)</option>
            <option value="date_asc">Datum (nejstarší)</option>
            <option value="amount_desc">Částka (největší)</option>
          </select>
        </div>
      </div>
    </div>
  </section>
  
  <section id="section-cards" style="display:none">
    <div class="card">
        <h2><i class="fa fa-credit-card" style="color:var(--accent)"></i> Moje Karty (Bankovní Přehled)</h2>
        <div class="muted">Kliknutím na ikonku zkopírujete údaj do schránky.</div>

        <div class="form-row" style="margin-top:20px">
            <select id="newCardType" style="flex-grow:0;">
                <option value="amex-platinum">American Express Platinum</option>
                <option value="amex-gold">American Express Gold</option>
                <option value="visa">Visa</option>
                <option value="mastercard">MasterCard</option>
            </select>
            <input type="text" id="newCardNumber" placeholder="Číslo karty (16-19 číslic)" style="flex-basis: 200px;"/>
            <input type="text" id="newCardExpiry" placeholder="MM/YY" style="flex-basis: 80px;"/>
            <input type="text" id="newCardCVV" placeholder="CVV" style="flex-basis: 60px;"/>
            <input type="text" id="newCardOwner" placeholder="Jméno (JOHN DOE)"/>
            <button class="btn" onclick="addCard()"><i class="fa fa-plus"></i> Přidat</button>
        </div>

        <div id="cardsList" class="card-container-wrap">
             </div>
    </div>
  </section>

  <section id="section-goals" style="display:none">
    <div class="card">
        <h2><i class="fa fa-calendar-check" style="color:#ff9900;"></i> Trvalé Platby k Úhradě (BOD 1)</h2>
        <div class="muted">Přehled stálých výdajů, kde můžete **vybrat, že je platba zaplacená**.</div>
        <div id="recurringPaymentsGoalList" style="margin-top:10px"></div>
    </div>
    
    <div class="card" style="margin-top:16px;">
      <h2><i class="fa fa-piggy-bank"></i> Spořicí Cíle</h2>
      <div class="muted">Sledujte svůj pokrok v ukládání peněz.</div>
      <div style="margin-top:12px">
        <div class="form-row">
            <input type="text" id="newGoalName" placeholder="Název cíle (např. 'Nové bydlení')" style="flex-grow:1"/>
            <input type="number" id="newGoalTarget" placeholder="Cílová částka"/>
            <input type="number" id="newGoalSaved" placeholder="Aktuálně naspořeno"/>
            <button class="btn" onclick="addGoal()"><i class="fa fa-plus-circle"></i> Vytvořit cíl</button>
        </div>
        <div id="goalsList" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <section id="section-stats" style="display:none">
    <div class="card">
      <h2><i class="fa fa-chart-pie"></i> Finanční Analýza (BOD 2)</h2>
      <div class="muted">Statistiky a souhrn pro aktuální období filtru (nastavené v sekci Účet).</div>

      <div class="stat-list" id="statCards">
        <div class="stat-card balance">
            <div class="muted">Zůstatek (Příjmy - Výdaje)</div>
            <div class="value" id="statBalance">0 Kč</div>
        </div>
        <div class="stat-card income">
            <div class="muted">Celkové Příjmy</div>
            <div class="value" id="statIncome">0 Kč</div>
        </div>
        <div class="stat-card expense">
            <div class="muted">Celkové Výdaje</div>
            <div class="value" id="statExpense">0 Kč</div>
        </div>
      </div>
      
      <h3 style="margin-top:25px"><i class="fa fa-tags"></i> Rozdělení podle kategorií</h3>
      <p class="muted">Kolik peněz šlo na jednotlivé kategorie (pro filtrované období).</p>
      
      <div id="categoryStats" class="stat-list" style="margin-top:12px">
          </div>
    </div>
  </section>
  
  <section id="section-history" style="display:none">
    <div class="card">
        <h2><i class="fa fa-calendar-alt"></i> Měsíční Historie a Grafy</h2>
        <div class="muted">Přehled hospodaření za minulých 12 měsíců.</div>
        <div id="historyList" class="history-list" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:15px; margin-top:15px;">
            </div>
    </div>
  </section>

  <section id="section-settings" style="display:none">
    <div class="card">
      <h2><i class="fa fa-calendar-alt" style="color:#ff9900;"></i> Správa Trvalých Plateb (BOD 1)</h2>
      <p class="muted">Nastavte pravidelné platby (paušály, předplatné), které se budou automaticky odečítat.</p>

      <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;border:1px solid var(--border);padding:15px;border-radius:12px;background:var(--bg)">
        <input type="text" id="newRecurringName" placeholder="Název platby (např. 'Netflix')" style="flex-grow:1"/>
        <input type="number" id="newRecurringAmount" placeholder="Částka (Kč)"/>
        <select id="newRecurringDay" style="flex-grow:0; min-width:unset; flex-basis:120px;"></select>
        <select id="newRecurringCategory" style="flex-basis: 150px;"></select>
        <button class="btn" onclick="addRecurringPayment()"><i class="fa fa-plus"></i> Přidat Platbu</button>
      </div>
      
      <div id="recurringListManagement" style="margin-top:20px"></div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h2><i class="fa fa-wrench"></i> Správa kategorií</h2>
      <p class="muted">Přidejte nebo odstraňte kategorie pro přesnější přehled.</p>
      
      <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;border:1px solid var(--border);padding:15px;border-radius:12px;background:var(--bg)">
        <select id="categoryType">
          <option value="expense">Výdajová</option>
          <option value="income">Příjmová</option>
        </select>
        <input type="text" id="newCategoryName" placeholder="Název kategorie (např. 'Káva')" style="flex-grow:1"/>
        <button class="btn" onclick="addCategory()"><i class="fa fa-plus"></i> Přidat</button>
      </div>

      <div id="categoryList" style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;">
        </div>

    </div>

    <div class="card" style="margin-top:16px;">
      <h2><i class="fa fa-database"></i> Databáze</h2>
      <p class="muted">Možnosti zálohování, obnovení a smazání dat.</p>

      <div style="margin-top:10px;display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn" onclick="exportAllJSON()"><i class="fa fa-download"></i> Exportovat data (JSON)</button>
        
        <input type="file" id="importJsonFile" accept=".json" style="display:none;" onchange="importAllJSON(event)">
        <button class="btn secondary" onclick="document.getElementById('importJsonFile').click()"><i class="fa fa-upload"></i> Nahrát JSON data</button>
        <button class="btn danger" onclick="clearAll()"><i class="fa fa-trash"></i> Smazat VŠECHNA data</button>
      </div>
    </div>
  </section>

</main>

<div class="footer-nav">
  <button data-section="budget" class="active" onclick="showSection(event)">
      <i class="fa fa-wallet"></i>
      <span>Účet</span>
  </button>
  <button data-section="cards" onclick="showSection(event)">
      <i class="fa fa-credit-card"></i>
      <span>Karty</span>
  </button>
  <button data-section="goals" onclick="showSection(event)">
      <i class="fa fa-piggy-bank"></i>
      <span>Cíle</span>
  </button>
  <button data-section="stats" onclick="showSection(event)">
      <i class="fa fa-chart-line"></i>
      <span>Analýza</span>
  </button>
  <button data-section="settings" onclick="showSection(event)">
      <i class="fa fa-cog"></i>
      <span>Správa</span>
  </button>
</div>

<div id="transactionModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h2 id="modalTransactionTitle" style="margin-bottom:20px">Úprava Transakce</h2>
        <div class="form-row">
            <input type="date" id="modalTDate" />
            <input type="text" id="modalTDesc" placeholder="Popis transakce"/>
            <input type="number" id="modalTAmount" placeholder="Částka"/>
            <select id="modalTType">
              <option value="expense">Platba / Výdaj</option>
              <option value="income">Přijatá platba / Příjem</option>
            </select>
            <select id="modalTCategory"></select>
        </div>
        <div class="modal-footer" style="display:flex;justify-content:space-between; margin-top:20px;">
            <button class="btn danger" id="modalDeleteBtn"><i class="fa fa-trash"></i> Smazat</button>
            <button class="btn" onclick="saveTransactionProfile()"><i class="fa fa-save"></i> Uložit Změny</button>
        </div>
        <button class="btn secondary" onclick="closeModal('transactionModal')" style="width:100%; margin-top:10px;"><i class="fa fa-times"></i> Zavřít</button>
    </div>
</div>

<div id="goalModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h2 id="modalGoalTitle" style="margin-bottom:20px">Úprava Cíle</h2>
        <div class="form-row">
            <input type="text" id="modalGoalName" placeholder="Název cíle" style="flex-grow:1"/>
            <input type="number" id="modalGoalTarget" placeholder="Cílová částka"/>
            <input type="number" id="modalGoalSaved" placeholder="Aktuálně naspořeno" disabled title="Spravováno přes investice níže" style="background:var(--border);"/>
        </div>
        
        <h3 style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;"><i class="fa fa-plus"></i> Přidat Investici</h3>
        <p class="muted">Přidejte částku, která se zároveň odečte z vašeho rozpočtu.</p>
        <div class="form-row">
            <input type="date" id="modalInvestDate" style="flex-basis: 150px;"/>
            <input type="number" id="modalInvestAmount" placeholder="Částka k investování"/>
            <button class="btn" style="background:var(--accent2)" onclick="addInvestmentFromModal()"><i class="fa fa-plus-circle"></i> Investovat</button>
        </div>

        <div class="modal-footer" style="display:flex;justify-content:space-between; margin-top:20px;">
            <button class="btn danger" id="modalGoalDeleteBtn"><i class="fa fa-trash"></i> Smazat Cíl</button>
            <button class="btn" onclick="saveGoalProfile()"><i class="fa fa-save"></i> Uložit Cíl</button>
        </div>
        <button class="btn secondary" onclick="closeModal('goalModal')" style="width:100%; margin-top:10px;"><i class="fa fa-times"></i> Zavřít</button>
    </div>
</div>

<div class="card-copy-status" id="global-copy-status">Zkopírováno!</div>

<div id="recurringModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h2 id="modalRecurringTitle" style="margin-bottom:20px">Úprava Trvalé Platby</h2>
        <div class="form-row">
            <input type="text" id="modalRName" placeholder="Název platby" style="flex-grow:1"/>
            <input type="number" id="modalRAmount" placeholder="Částka"/>
            <select id="modalRDay" style="flex-grow:0; min-width:unset; flex-basis:120px;"></select>
            <select id="modalRCategory"></select>
        </div>
        <p class="muted" style="margin-top:10px;">Poslední úhrada: <strong id="modalRLastPaid">Nezaplaceno</strong></p>

        <div class="modal-footer" style="display:flex;justify-content:space-between; margin-top:20px;">
            <button class="btn danger" id="modalRDeleteBtn"><i class="fa fa-trash"></i> Smazat</button>
            <button class="btn" onclick="saveRecurringProfile()"><i class="fa fa-save"></i> Uložit Změny</button>
        </div>
        <button class="btn secondary" onclick="closeModal('recurringModal')" style="width:100%; margin-top:10px;"><i class="fa fa-times"></i> Zavřít</button>
    </div>
</div>


<script>
// PŮVODNÍ KÓD ZŮSTÁVÁ, OPRAVENÁ A ROZŠÍŘENÁ LOGIKA NÍŽE

/* =========================
   Storage & data model
   ========================= */
const LS_TRANSACTIONS = 'finance_transactions_v1';
const LS_GOALS = 'finance_goals_v1';
const LS_CATEGORIES = 'finance_categories_v1'; 
const LS_CURRENCY = 'finance_currency_v1';
const LS_EXCHANGE_RATE = 'finance_exchange_rate_v1';
const LS_CARDS = 'finance_cards_v2'; 
const LS_RECURRING_PAYMENTS = 'finance_recurring_payments_v1'; // NOVÁ KONSTANTA

let store = {
  transactions: [], 
  goals: [],        
  categories: [],   
  cards: [], 
  recurringPayments: [], // NOVÉ: trvalé platby
  currency: 'CZK',
  exchangeRate: 1, 
};

function loadStore(){
  try{
    const rawT = localStorage.getItem(LS_TRANSACTIONS);
    if(rawT) store.transactions = JSON.parse(rawT).map(t => ({
      ...t, 
      id: t.id || Math.random().toString(36).substring(2, 9) 
    }));
    else store.transactions = [];

    const rawG = localStorage.getItem(LS_GOALS);
    if(rawG) store.goals = JSON.parse(rawG).map(g => ({
        ...g, 
        id: g.id || Math.random().toString(36).substring(2, 9)
    }));
    else store.goals = [];
    
    const rawCards = localStorage.getItem(LS_CARDS);
    if(rawCards) store.cards = JSON.parse(rawCards).map(c => ({
        ...c, 
        id: c.id || Math.random().toString(36).substring(2, 9)
    }));
    else store.cards = [];
    
    // NAČTENÍ TRVALÝCH PLATEB
    const rawR = localStorage.getItem(LS_RECURRING_PAYMENTS);
    if(rawR) store.recurringPayments = JSON.parse(rawR).map(r => ({
        ...r, 
        id: r.id || Math.random().toString(36).substring(2, 9),
        // Zajištění, že lastPaidDate je Date (nebo null)
        lastPaidDate: r.lastPaidDate ? r.lastPaidDate : null 
    }));
    else store.recurringPayments = [];


    const rawC = localStorage.getItem(LS_CATEGORIES);
    if(rawC) store.categories = JSON.parse(rawC);
    
    // Zajištění výchozích kategorií
    if(!store.categories || store.categories.length === 0) {
        store.categories = [
            { name: 'Nezadáno', type: 'expense' },
            { name: 'Jídlo', type: 'expense' },
            { name: 'Nájem/Bydlení', type: 'expense' },
            { name: 'Volný čas', type: 'expense' },
            { name: 'Investice', type: 'expense' },
            { name: 'Výplata', type: 'income' },
            { name: 'Bonus', type: 'income' },
        ];
    }
    
    const rawCurrency = localStorage.getItem(LS_CURRENCY);
    store.currency = rawCurrency || 'CZK';
    $('currencySelect').value = store.currency;
    
    const rawRate = localStorage.getItem(LS_EXCHANGE_RATE);
    store.exchangeRate = parseFloat(rawRate) || 1;


  }catch(e){
    console.warn('Load error',e);
    store.transactions = [];
    store.goals = [];
    store.cards = []; 
    store.recurringPayments = []; // Reset i pro nové pole
    store.categories = [ { name: 'Nezadáno', type: 'expense' } ];
    store.currency = 'CZK';
    store.exchangeRate = 1;
  }
}
function saveStore(){
  localStorage.setItem(LS_TRANSACTIONS, JSON.stringify(store.transactions));
  localStorage.setItem(LS_GOALS, JSON.stringify(store.goals));
  localStorage.setItem(LS_CATEGORIES, JSON.stringify(store.categories));
  localStorage.setItem(LS_CURRENCY, store.currency);
  localStorage.setItem(LS_EXCHANGE_RATE, store.exchangeRate.toFixed(4));
  localStorage.setItem(LS_CARDS, JSON.stringify(store.cards)); 
  localStorage.setItem(LS_RECURRING_PAYMENTS, JSON.stringify(store.recurringPayments)); // ULOŽENÍ TRVALÝCH PLATEB
}

/* helpers */
function $(id){return document.getElementById(id)}
function closeModal(id){ $(id).style.display = 'none'; currentTransaction = null; currentGoal = null; currentRecurring = null; } // Přidána nová proměnná
let currentRecurring = null;


function formatDate(d){ 
    if(!d) return '';
    const dt = new Date(d); 
    if(isNaN(dt.getTime())) { return d; }
    return dt.toLocaleDateString('cs-CZ'); 
}
function formatAmount(amount, currencyCode = store.currency){
    let finalAmount = amount;
    let code = 'CZK';
    let locale = 'cs-CZ';

    if (currencyCode === 'EUR') {
        finalAmount = amount / store.exchangeRate;
        code = 'EUR';
        locale = 'de-DE';
    } else { // CZK
        code = 'CZK';
        locale = 'cs-CZ';
    }

    return new Intl.NumberFormat(locale, { style: 'currency', currency: code, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(finalAmount);
}
function todayShort(){ /* Funkce nebyla použita, ponecháno pro konzistenci */ }


/* MĚNA A KURZ */
function fetchExchangeRate(){
    const simulatedRate = 24.50; 
    store.exchangeRate = simulatedRate;
    saveStore();
    $('exchangeRateDisplay').textContent = `Kurz: 1 € ≈ ${store.exchangeRate.toFixed(2)} Kč`;
}

function changeCurrency(){
    store.currency = $('currencySelect').value;
    saveStore();
    applyFilter();
    renderGoals();
    renderRecurringPaymentsGoalSection(); // Znovu vykreslit trvalé platby
    if(document.querySelector('.footer-nav button[data-section="stats"]').classList.contains('active')) computeStats();
    if(document.querySelector('.footer-nav button[data-section="history"]').classList.contains('active')) renderHistory();
}


/* NAVIGACE */
function showSection(e){
  const btn = e.currentTarget;
  document.querySelectorAll('.footer-nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const sec = btn.getAttribute('data-section');
  document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
  $('section-'+sec).style.display = 'block'; 
  
  // Přesun na začátek obsahu sekce (.wrap je element, který se scrolluje)
  document.querySelector('.wrap').scrollTop = 0;
  
  if(sec === 'stats') computeStats();
  if(sec === 'cards') renderCards(); 
  if(sec === 'goals') { 
    renderGoals();
    renderRecurringPaymentsGoalSection(); // Zobrazení trvalých plateb v sekci Cíle
  }
  if(sec === 'history') renderHistory();
  if(sec === 'settings') renderCategories(); renderRecurringPaymentsManagement(); // Render správy trvalých plateb
}


/* MĚSÍČNÍ FILTR - OPRAVENO */
function applyMonthFilter() {
    const selected = $('monthSelect').value;
    
    if (selected === 'custom') {
        $('filterFrom').disabled = false;
        $('filterTo').disabled = false;
        $('filterFrom').style.background = 'var(--card)';
        $('filterTo').style.background = 'var(--card)';
    } else {
        const [year, month] = selected.split('-');
        // Měsíc v JS je 0-11, takže month - 1
        const dateFrom = new Date(year, month - 1, 1);
        const dateTo = new Date(year, month, 0); 

        // Nastavení hodnot do inputů pro vizuální kontrolu, ale ponecháme disabled
        $('filterFrom').value = dateFrom.toISOString().slice(0, 10);
        $('filterTo').value = dateTo.toISOString().slice(0, 10);
        
        $('filterFrom').disabled = true;
        $('filterTo').disabled = true;
        $('filterFrom').style.background = 'var(--bg)';
        $('filterTo').style.background = 'var(--bg)';
    }
    applyFilter();
}

function renderMonthOptions() {
    const select = $('monthSelect');
    select.innerHTML = '';

    const today = new Date();
    const options = [];
    const monthNames = ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen", "Červenec", "Srpen", "Září", "Říjen", "Listopad", "Prosinec"];

    for (let i = 0; i < 12; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const monthStr = month.toString().padStart(2, '0');
        const value = `${year}-${monthStr}`;
        const label = `${monthNames[date.getMonth()]} ${year}`;
        
        options.push({ value, label });
    }
    
    options.reverse().forEach((opt, index) => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        if (index === options.length - 1) { 
            option.selected = true;
        }
        select.appendChild(option);
    });

    const customOption = document.createElement('option');
    customOption.value = 'custom';
    customOption.textContent = 'Vlastní období...';
    select.appendChild(customOption);
    
    applyMonthFilter(); 
}

/* SPRÁVA KATEGORIÍ */
function updateCategorySelects() {
    const selects = [$('transactionCategory'), $('modalTCategory'), $('newRecurringCategory'), $('modalRCategory')];
    
    // Pro trvalé platby potřebujeme jen výdajové kategorie
    const expenseCategories = store.categories.filter(c => c.type === 'expense');
    
    selects.forEach(select => {
        if (!select) return; 
        
        const isModalT = select.id === 'modalTCategory';
        const isRecurring = select.id.includes('RecurringCategory');
        
        if (isRecurring) {
            select.innerHTML = '';
            expenseCategories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.name;
                opt.textContent = c.name;
                select.appendChild(opt);
            });
            return;
        }

        // Pro běžné transakce (závisí na typu transakce)
        let currentType;
        if (isModalT) {
            currentType = $('modalTType')?.value || 'expense';
        } else {
            currentType = $('transactionType')?.value || 'expense';
        }
        
        let currentSelected = select.value;
        
        select.innerHTML = '';
        const relevantCategories = store.categories.filter(c => c.type === currentType);

        if (relevantCategories.length === 0) {
            const opt = document.createElement('option');
            opt.value = 'Nezadáno';
            opt.textContent = 'Nezadáno';
            select.appendChild(opt);
            return;
        }

        relevantCategories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.textContent = c.name;
            select.appendChild(opt);
        });

        if (currentSelected && relevantCategories.some(c => c.name === currentSelected)) {
            select.value = currentSelected;
        } else {
            select.value = relevantCategories[0]?.name || 'Nezadáno';
        }
    });
}
if ($('transactionType')) {
    $('transactionType').onchange = updateCategorySelects;
}

function renderCategories() {
    const list = $('categoryList');
    list.innerHTML = '';

    store.categories.forEach((cat, index) => {
        const tag = document.createElement('div');
        tag.className = `category-tag ${cat.type === 'expense' ? 'danger' : 'income'}`;
        tag.style.cssText = `
            background-color: ${cat.type === 'expense' ? 'var(--danger)' : 'var(--accent2)'};
            color: white; padding: 5px 10px; border-radius: 6px; 
            display: flex; align-items: center; gap: 5px; font-size: 0.9em;
            font-weight: 600;
        `;
        // Opraveno: Přidání indexu pro spolehlivé smazání
        tag.innerHTML = `${cat.name} <i class="fa fa-times" style="cursor:pointer; font-size: 0.9em;" onclick="deleteCategory(${index}, event)"></i>`;
        list.appendChild(tag);
    });
    
    updateCategorySelects();
}

function addCategory() {
    const name = $('newCategoryName').value.trim();
    const type = $('categoryType').value;

    if (!name) {
        alert('Zadejte prosím název kategorie.');
        return;
    }
    if (store.categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
        alert('Tato kategorie již existuje.');
        return;
    }
    
    store.categories.push({ name: name, type: type });
    saveStore();
    $('newCategoryName').value = '';
    renderCategories();
    // Aktualizovat i výběry trvalých plateb
    updateCategorySelects();
    renderRecurringPaymentsManagement();
    renderRecurringPaymentsGoalSection();
}

function deleteCategory(index, event) {
    if (event) event.stopPropagation(); 

    const catToDelete = store.categories[index];

    if (['Investice', 'Nezadáno', 'Jídlo', 'Výplata', 'Nájem/Bydlení', 'Volný čas', 'Bonus'].includes(catToDelete.name)) {
        alert('Tuto výchozí/klíčovou kategorii nelze smazat.');
        return;
    }
    
    if (confirm(`Opravdu chcete smazat kategorii "${catToDelete.name}"? Všechny transakce s touto kategorií budou převedeny na "Nezadáno".`)) {
        store.transactions.forEach(t => {
            if (t.category === catToDelete.name) {
                t.category = 'Nezadáno'; // Převedení transakcí
            }
        });
        // Převedení trvalých plateb
        store.recurringPayments.forEach(r => {
            if (r.category === catToDelete.name) {
                r.category = 'Nezadáno'; 
            }
        });


        store.categories.splice(index, 1);
        saveStore();
        renderCategories();
        applyFilter(); 
        computeStats(); 
    }
}


/* BUDGET - přidání transakce */
function addTransaction(){
    const date = $('transactionDate').value;
    const desc = $('transactionDesc').value.trim();
    const amount = parseFloat($('transactionAmount').value);
    const type = $('transactionType').value;
    const category = $('transactionCategory').value; 
    
    if(!date || !desc || isNaN(amount) || amount <= 0){
        alert('Vyplňte prosím datum, popis a platnou kladnou částku.');
        return;
    }

    const newTransaction = {
        id: Math.random().toString(36).substring(2, 9),
        date: date,
        desc: desc,
        amount: amount, 
        type: type,
        category: category, 
    };

    store.transactions.push(newTransaction);
    saveStore();
    
    $('transactionDesc').value = '';
    $('transactionAmount').value = '';
    
    applyFilter();
    renderMonthOptions(); 
}

/* BUDGET - transakční modal */
let currentTransaction = null;

function updateModalCategorySelect(currentType, currentCategoryName) {
    const categorySelect = $('modalTCategory');
    if(!categorySelect) return;
    categorySelect.innerHTML = '';
    const relevantCategories = store.categories.filter(c => c.type === currentType);
    
    relevantCategories.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = c.name;
        categorySelect.appendChild(opt);
    });
    
    // Nastavení vybrané kategorie
    if (currentCategoryName && relevantCategories.some(c => c.name === currentCategoryName)) {
         categorySelect.value = currentCategoryName;
    } else {
         categorySelect.value = relevantCategories[0]?.name || 'Nezadáno'; 
    }
}

function openTransactionModal(id){
    currentTransaction = store.transactions.find(t => t.id === id);
    if(!currentTransaction) return;
    
    // Využití již existujícího modalu v DOM (HTML těsně před script tagem)
    
    $('modalTransactionTitle').innerHTML = `<i class="fa fa-edit"></i> Úprava transakce: ${currentTransaction.desc}`;
    
    $('modalTDate').value = currentTransaction.date;
    $('modalTDesc').value = currentTransaction.desc;
    $('modalTAmount').value = currentTransaction.amount; 
    $('modalTType').value = currentTransaction.type;
    
    // Inicializace výběru kategorie v modalu
    updateModalCategorySelect(currentTransaction.type, currentTransaction.category); 
    
    // Přidání listeneru, aby se při změně typu aktualizovaly kategorie
    if ($('modalTType').onchange === null) {
        $('modalTType').onchange = (e) => {
            const newType = e.target.value;
            // Předání aktuální kategorie jako suggestion, pokud by existovala
            updateModalCategorySelect(newType, currentTransaction.category);
        };
    }
    
    $('modalDeleteBtn').onclick = () => deleteTransaction(currentTransaction.id);
    
    $('transactionModal').style.display = 'flex';
}

function saveTransactionProfile(){
    if(!currentTransaction) return;
    
    const newType = $('modalTType').value;
    const newCategory = $('modalTCategory').value;
    
    const amount = parseFloat($('modalTAmount').value); 
    if(!$('modalTDate').value || !$('modalTDesc').value.trim() || isNaN(amount) || amount <= 0){
        alert('Vyplňte prosím datum, popis a platnou kladnou částku.');
        return;
    }
    
    // Nalezení indexu transakce a aktualizace
    const index = store.transactions.findIndex(t => t.id === currentTransaction.id);
    if(index !== -1) {
        store.transactions[index] = {
            ...store.transactions[index],
            date: $('modalTDate').value,
            desc: $('modalTDesc').value.trim(),
            amount: amount,
            type: newType,
            category: newCategory,
        };
    }

    saveStore();
    closeModal('transactionModal');
    applyFilter();
    computeStats();
}

function deleteTransaction(id){
    if(confirm('Opravdu chcete tuto transakci smazat?')) {
        store.transactions = store.transactions.filter(t => t.id !== id);
        saveStore();
        closeModal('transactionModal');
        applyFilter();
        computeStats();
    }
}


/* GOALS - Ponecháno (OPRAVA BODU 3) */
function addGoal(){
    const name = $('newGoalName').value.trim();
    const target = parseFloat($('newGoalTarget').value);
    const saved = parseFloat($('newGoalSaved').value) || 0; 

    if(!name || isNaN(target) || target <= 0 || isNaN(saved) || saved < 0){
        alert('Vyplňte prosím název a platnou cílovou částku.');
        return;
    }
    
    const newGoal = {
        id: Math.random().toString(36).substring(2, 9),
        name: name,
        target: target,
        saved: saved,
    };

    store.goals.push(newGoal);
    saveStore();
    
    $('newGoalName').value = '';
    $('newGoalTarget').value = '';
    $('newGoalSaved').value = '';
    
    renderGoals();
}

function renderGoals(){
    const list = $('goalsList');
    list.innerHTML = '';

    if (store.goals.length === 0) {
        list.innerHTML = '<div class="muted" style="margin-top:10px">Zatím nebyly přidány žádné cíle.</div>';
        return;
    }

    store.goals.forEach(g => {
        const percentage = g.target > 0 ? ((g.saved / g.target) * 100).toFixed(1) : 0;
        const progressWidth = Math.min(100, parseFloat(percentage)) + '%';
        const isComplete = g.saved >= g.target;

        const item = document.createElement('div');
        item.className = 'goal-item card';
        item.style.cursor = 'pointer';
        item.onclick = () => openGoalModal(g.id);
        
        item.innerHTML = `
            <div class="goal-item-header" style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-size:1.1em; font-weight:700">${g.name} ${isComplete ? '<i class="fa fa-check-circle" style="color:var(--accent2)"></i>' : ''}</div>
                <div class="muted" style="font-size:0.9em; font-weight:700">${percentage}%</div>
            </div>
            <div style="margin-top:10px;">
                <div class="muted" style="font-size:0.9em;">Naspořeno: <strong>${formatAmount(g.saved)}</strong> / Cíl: ${formatAmount(g.target)}</div>
                <div style="width:100%; height:8px; background:var(--bg); border-radius:4px; margin-top:5px; overflow:hidden;">
                    <div style="width: ${progressWidth}; height:100%; background:${isComplete ? 'var(--accent)' : 'var(--accent2)'}; transition:width 0.5s;"></div>
                </div>
            </div>
        `;
        list.appendChild(item);
    });
}

let currentGoal = null;

function openGoalModal(id){
    currentGoal = store.goals.find(g => g.id === id);
    if(!currentGoal) return;
    
    // Využití již existujícího modalu v DOM (HTML těsně před script tagem)
    
    $('modalGoalTitle').innerHTML = `<i class="fa fa-bullseye"></i> Úprava cíle: ${currentGoal.name}`;
    
    $('modalGoalName').value = currentGoal.name;
    $('modalGoalTarget').value = currentGoal.target;
    $('modalGoalSaved').value = currentGoal.saved;
    
    $('modalInvestAmount').value = '';
    $('modalInvestDate').value = new Date().toISOString().slice(0, 10);

    $('modalGoalDeleteBtn').onclick = () => deleteGoal(currentGoal.id);
    
    $('goalModal').style.display = 'flex';
}

function saveGoalProfile(){
    if(!currentGoal) return;
    
    const target = parseFloat($('modalGoalTarget').value);
    
    if(!$('modalGoalName').value.trim() || isNaN(target) || target <= 0){
        alert('Vyplňte prosím název a platnou cílovou částku.');
        return;
    }
    
    // Nalezení indexu cíle a aktualizace
    const index = store.goals.findIndex(g => g.id === currentGoal.id);
    if(index !== -1) {
        store.goals[index] = {
            ...store.goals[index],
            name: $('modalGoalName').value.trim(),
            target: target,
        };
    }
    
    saveStore();
    closeModal('goalModal');
    renderGoals();
}

function deleteGoal(id){
    if(confirm('Opravdu chcete tento investiční cíl smazat?')) {
        store.goals = store.goals.filter(g => g.id !== id);
        saveStore();
        closeModal('goalModal');
        renderGoals();
    }
}

function addInvestmentToGoal(goalId, amount, date){
    const goal = store.goals.find(g => g.id === goalId);
    if(!goal || isNaN(amount) || amount <= 0) return false;

    // 1. Přičtení k naspořené částce cíle
    goal.saved += amount;

    // 2. Vytvoření výdajové transakce (Investice)
    const newTransaction = {
        id: Math.random().toString(36).substring(2, 9),
        date: date,
        desc: `Investice do cíle: ${goal.name}`,
        amount: amount, 
        type: 'expense',
        category: 'Investice',
    };
    
    // Zajištění, že kategorie "Investice" existuje
    if (!store.categories.some(c => c.name === 'Investice')) {
        store.categories.push({ name: 'Investice', type: 'expense' });
    }

    store.transactions.push(newTransaction);
    
    saveStore();
    return true;
}

function addInvestmentFromModal(){
    if(!currentGoal) return;

    const amount = parseFloat($('modalInvestAmount').value);
    const date = $('modalInvestDate').value;

    if (isNaN(amount) || amount <= 0 || !date) {
        alert('Zadejte prosím platnou kladnou částku a datum pro investici.');
        return;
    }
    
    if (addInvestmentToGoal(currentGoal.id, amount, date)) {
        // Musíme znovu načíst aktuální cíl, protože addInvestmentToGoal ho změnila
        currentGoal = store.goals.find(g => g.id === currentGoal.id); 
        $('modalGoalSaved').value = currentGoal.saved;

        alert(`Investice ${formatAmount(amount)} byla přičtena k cíli "${currentGoal.name}" a odečtena z rozpočtu.`);

        $('modalInvestAmount').value = '';
        renderGoals();
        applyFilter(); 
    } else {
        alert('Nepodařilo se přidat investici. Zkuste to znovu.');
    }
}

/* ========================================================
   TRVALÉ PLATBY - LOGIKA (BOD 1)
   ======================================================== */

// Pomocná funkce pro naplnění výběru dnů v měsíci
function fillRecurringDaySelects() {
    const selects = [$('newRecurringDay'), $('modalRDay')];
    selects.forEach(select => {
        if (!select) return;
        select.innerHTML = '';
        for (let i = 1; i <= 31; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = i + '. den v měsíci';
            select.appendChild(opt);
        }
    });
}


function addRecurringPayment() {
    const name = $('newRecurringName').value.trim();
    const amount = parseFloat($('newRecurringAmount').value);
    const dueDate = parseInt($('newRecurringDay').value);
    const category = $('newRecurringCategory').value;

    if (!name || isNaN(amount) || amount <= 0 || isNaN(dueDate)) {
        alert('Vyplňte prosím název, platnou částku a den v měsíci.');
        return;
    }

    const newPayment = {
        id: Math.random().toString(36).substring(2, 9),
        name: name,
        amount: amount,
        dueDate: dueDate,
        category: category,
        lastPaidDate: null, // Ukládáme jako string "YYYY-MM-DD" nebo null
    };

    store.recurringPayments.push(newPayment);
    saveStore();

    $('newRecurringName').value = '';
    $('newRecurringAmount').value = '';

    renderRecurringPaymentsManagement();
    renderRecurringPaymentsGoalSection();
    applyFilter(); // Aktualizace přehledu
}

function renderRecurringPaymentsManagement() {
    fillRecurringDaySelects();
    updateCategorySelects(); // Zajistí, že kategorie jsou načteny
    
    const list = $('recurringListManagement');
    list.innerHTML = '';

    if (store.recurringPayments.length === 0) {
        list.innerHTML = '<div class="muted">Zatím nebyly přidány žádné trvalé platby.</div>';
        return;
    }

    // Získání aktuálního měsíce a roku z filtru (nebo z dneška, pokud filtr není aktivní)
    const filterFrom = $('filterFrom').value ? new Date($('filterFrom').value) : new Date();
    const filterTo = $('filterTo').value ? new Date($('filterTo').value) : new Date();
    
    const currentMonth = filterFrom.getMonth();
    const currentYear = filterFrom.getFullYear();
    
    // Pomocná funkce, která zjistí, zda byla platba uhrazena V AKTUÁLNÍM MĚSÍCI FILTRU
    const isPaidInCurrentFilterMonth = (payment) => {
        if (!payment.lastPaidDate) return false;
        const lastPaid = new Date(payment.lastPaidDate);
        // Kontroluje, zda datum úhrady spadá do rozsahu filtru
        return lastPaid >= filterFrom && lastPaid <= filterTo;
    };


    store.recurringPayments.forEach(r => {
        const isPaid = isPaidInCurrentFilterMonth(r);
        
        const item = document.createElement('div');
        item.className = 'card recurring-payment-card';
        item.style.marginBottom = '10px';
        item.style.cursor = 'pointer';
        item.onclick = () => openRecurringModal(r.id);

        let buttonHtml = '';
        if (isPaid) {
            // Platba je zaplacená v aktuálním období - tlačítko pro "znovuzapnutí"
            buttonHtml = `
                <div style="text-align:right; margin-top:10px;">
                    <span style="color:var(--accent2); font-weight:700; margin-right:10px;">
                        <i class="fa fa-check-circle"></i> Zaplaceno: ${formatDate(r.lastPaidDate)}
                    </span>
                    <button class="btn danger action-small" onclick="event.stopPropagation(); reactivateRecurringPayment('${r.id}')" title="Nastaví poslední úhradu na Null, aby se platba zobrazila jako NEUHRAZENÁ a připravila se na další úhradu.">
                        <i class="fa fa-redo"></i> Znovu Zapnout
                    </button>
                </div>
            `;
            item.style.borderLeftColor = 'var(--accent2)'; // Zelená, že je v tomto měsíci zaplaceno
        } else {
            // Platba není zaplacená v aktuálním období - jen informace o poslední úhradě
            const lastPaidInfo = r.lastPaidDate ? formatDate(r.lastPaidDate) : 'Nezaplaceno';
            buttonHtml = `
                <div style="text-align:right; margin-top:10px;">
                    <span class="muted" style="margin-right:10px;">Poslední úhrada: ${lastPaidInfo}</span>
                </div>
            `;
            item.style.borderLeftColor = '#ff9900'; // Oranžová, že je k úhradě
        }

        item.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:700; color:var(--text);">${r.name}</div>
                <div style="font-weight:700; color:var(--danger);">${formatAmount(r.amount)}</div>
            </div>
            <div class="muted" style="margin-top:5px; font-size:0.9em;">
                Den splatnosti: ${r.dueDate}. | Kategorie: ${r.category}
            </div>
            ${buttonHtml}
        `;
        list.appendChild(item);
    });
}

function reactivateRecurringPayment(id) {
    const payment = store.recurringPayments.find(r => r.id === id);
    if (!payment) return;

    if (confirm(`Opravdu chcete platbu "${payment.name}" nastavit jako NEUHRAZENOU pro aktuální období?`)) {
        // Nastavíme lastPaidDate na null, což znamená, že je potřeba ji znova zaplatit.
        payment.lastPaidDate = null; 
        saveStore();
        
        alert(`Platba "${payment.name}" byla znovu aktivována.`);
        
        renderRecurringPaymentsManagement();
        renderRecurringPaymentsGoalSection();
        applyFilter();
    }
}


function openRecurringModal(id) {
    currentRecurring = store.recurringPayments.find(r => r.id === id);
    if (!currentRecurring) return;

    fillRecurringDaySelects();
    updateCategorySelects();

    $('modalRecurringTitle').innerHTML = `<i class="fa fa-edit"></i> Úprava trvalé platby: ${currentRecurring.name}`;
    $('modalRName').value = currentRecurring.name;
    $('modalRAmount').value = currentRecurring.amount;
    $('modalRDay').value = currentRecurring.dueDate;
    $('modalRCategory').value = currentRecurring.category;
    $('modalRLastPaid').textContent = currentRecurring.lastPaidDate ? formatDate(currentRecurring.lastPaidDate) : 'Nezaplaceno';

    $('modalRDeleteBtn').onclick = () => deleteRecurringPayment(currentRecurring.id);
    
    $('recurringModal').style.display = 'flex';
}

function saveRecurringProfile() {
    if (!currentRecurring) return;

    const name = $('modalRName').value.trim();
    const amount = parseFloat($('modalRAmount').value);
    const dueDate = parseInt($('modalRDay').value);
    const category = $('modalRCategory').value;

    if (!name || isNaN(amount) || amount <= 0 || isNaN(dueDate)) {
        alert('Vyplňte prosím název, platnou částku a den v měsíci.');
        return;
    }

    const index = store.recurringPayments.findIndex(r => r.id === currentRecurring.id);
    if (index !== -1) {
        store.recurringPayments[index] = {
            ...store.recurringPayments[index],
            name: name,
            amount: amount,
            dueDate: dueDate,
            category: category,
        };
    }

    saveStore();
    closeModal('recurringModal');
    renderRecurringPaymentsManagement();
    renderRecurringPaymentsGoalSection();
    applyFilter();
}

function deleteRecurringPayment(id) {
    if (confirm('Opravdu chcete tuto trvalou platbu smazat?')) {
        store.recurringPayments = store.recurringPayments.filter(r => r.id !== id);
        saveStore();
        closeModal('recurringModal');
        renderRecurringPaymentsManagement();
        renderRecurringPaymentsGoalSection();
        applyFilter();
    }
}

// Zobrazení v sekci Cíle a úhrada
function renderRecurringPaymentsGoalSection() {
    const list = $('recurringPaymentsGoalList');
    list.innerHTML = '';
    
    // Získání aktuálně nezaplacených plateb pro aktuální měsíc (na základě filtru)
    const upcoming = getUpcomingPayments($('filterFrom').value, $('filterTo').value);
    
    if (upcoming.length === 0) {
        list.innerHTML = '<div class="muted">Žádné trvalé platby k úhradě v tomto období.</div>';
        return;
    }
    
    upcoming.forEach(r => {
        const item = document.createElement('div');
        item.className = 'goal-item card recurring-payment-card';
        item.style.marginBottom = '10px';
        
        item.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-size:1.1em; font-weight:700">${r.name}</div>
                <div style="font-weight:700; color:var(--danger);">${formatAmount(r.amount)}</div>
            </div>
            <div class="muted" style="margin-top:5px; font-size:0.9em;">
                Splatnost: ${r.dueDate}. den | Kategorie: ${r.category}
            </div>
            <div style="margin-top:15px; text-align:right;">
                <button class="btn secondary action-small" onclick="openRecurringModal('${r.id}')"><i class="fa fa-edit"></i> Upravit Profil</button>
                <button class="btn" style="background:var(--danger);" onclick="markRecurringPaymentAsPaid('${r.id}')"><i class="fa fa-check"></i> **Zaplatit** (${formatAmount(r.amount)})</button>
            </div>
        `;
        list.appendChild(item);
    });
}

function markRecurringPaymentAsPaid(id) {
    const payment = store.recurringPayments.find(r => r.id === id);
    if (!payment) return;

    if (!confirm(`Opravdu chcete zaznamenat úhradu ${formatAmount(payment.amount)} za "${payment.name}"? Tímto se platba **odečte** z Vašeho zůstatku.`)) {
        return;
    }
    
    const today = new Date().toISOString().slice(0, 10);
    
    // 1. Vytvoření transakce
    const newTransaction = {
        id: Math.random().toString(36).substring(2, 9),
        date: today,
        desc: `Trvalá platba: ${payment.name}`,
        amount: payment.amount, 
        type: 'expense',
        category: payment.category,
    };
    store.transactions.push(newTransaction);

    // 2. Aktualizace lastPaidDate (důležité pro určení, že je uhrazeno v tomto měsíci)
    payment.lastPaidDate = today; 

    saveStore();
    
    alert(`Trvalá platba za "${payment.name}" byla uhrazena a odečtena z rozpočtu.`);
    
    renderRecurringPaymentsGoalSection();
    applyFilter();
    renderRecurringPaymentsManagement(); // Aktualizace i Správy
}


// ZÍSKÁNÍ NEUHRAZENÝCH PLATEB V RÁMCI AKTUÁLNÍHO FILTRU
function getUpcomingPayments(filterFrom, filterTo) {
    if (!filterFrom || !filterTo) return [];
    
    const fDate = new Date(filterFrom);
    const tDate = new Date(filterTo);
    // Nastavíme konec filtru na konec dne pro přesné porovnání
    let filterToDate = tDate;
    filterToDate.setHours(23, 59, 59, 999); 

    return store.recurringPayments.filter(r => {
        const lastPaidDate = r.lastPaidDate ? new Date(r.lastPaidDate) : null;
        const dueDay = r.dueDate;
        
        // Vytvoření data splatnosti pro aktuální měsíc filtru
        // Vezmeme rok a měsíc z data filtru
        const filterMonth = fDate.getMonth(); 
        const filterYear = fDate.getFullYear();
        
        // Ošetření, že den 31 neexistuje v únoru atp. (převedeno na poslední den měsíce)
        const dateObj = new Date(filterYear, filterMonth, dueDay); 
        
        // Zkontrolujeme, zda datum splatnosti spadá do rozsahu filtru (jednoduchá kontrola)
        const isDueInFilterPeriod = dateObj >= fDate && dateObj <= filterToDate;

        if (isDueInFilterPeriod) {
            // Je splatná v tomto měsíci (období)
            if (lastPaidDate) {
                // Kontrola, zda poslední úhrada spadá do AKTIVNÍHO FILTRAČNÍHO ROZSAHU
                if (lastPaidDate >= fDate && lastPaidDate <= filterToDate) {
                    return false; // Již zaplaceno pro toto období filtru
                }
            }
            return true; // Je splatná a neuhrazená v rámci filtru
        }
        
        return false; // Nespadá do období
    });
}


/* Ostatní funkce (Tabulka, Filtry, Statistiky, Historie, Export/Import) - Upraveno */
let currentTransactions = []; 

function renderTransactionTable(transactions){
    currentTransactions = transactions;
    const tbody = $('tableBody');
    tbody.innerHTML = '';
    let totalBalance = 0;

    // 1. Získání nezaplacených trvalých plateb
    const upcomingPayments = getUpcomingPayments($('filterFrom').value, $('filterTo').value);
    let upcomingPaymentsTotal = upcomingPayments.reduce((sum, p) => sum + p.amount, 0);

    // 2. Vykreslení detailu nezaplacených plateb (pod hlavním panelem)
    const upcomingDetail = $('upcomingPaymentsDetail');
    const upcomingList = $('upcomingPaymentsList');
    upcomingList.innerHTML = '';
    
    if (upcomingPayments.length > 0) {
        upcomingDetail.style.display = 'block';
        upcomingPayments.forEach(r => {
             const item = document.createElement('div');
             item.className = 'upcoming-item';
             item.innerHTML = `
                 <div>
                     <i class="fa fa-file-invoice" style="color:#ff9900;"></i> 
                     <strong>${r.name}</strong> 
                     <span class="muted" style="font-size:0.9em;">(Splatnost ${r.dueDate}. den, Kat: ${r.category})</span>
                 </div>
                 <div style="font-weight:700; color:var(--danger);">${formatAmount(r.amount)}</div>
             `;
             upcomingList.appendChild(item);
        });
    } else {
        upcomingDetail.style.display = 'none';
    }


    transactions.forEach((t) => {
        const tr = document.createElement('tr');
        const isExpense = t.type === 'expense';
        
        const amountDisplay = t.amount; 
        
        if(isExpense) totalBalance -= amountDisplay;
        else totalBalance += amountDisplay;

        const td1 = document.createElement('td'); td1.textContent = formatDate(t.date);
        const td2 = document.createElement('td'); 
        td2.innerHTML = `<strong>${t.desc}</strong><br><span class="muted">${t.category || 'Nezadáno'}</span>`;
        
        const td3 = document.createElement('td'); 
        const badge = document.createElement('span');
        badge.className = `category-tag ${isExpense ? 'expense' : 'income'}`;
        badge.textContent = isExpense ? 'Výdaj' : 'Příjem';
        badge.style.cssText = `
            background-color: ${isExpense ? 'var(--danger)' : 'var(--accent2)'};
            color: white; padding: 5px 10px; border-radius: 6px; font-size: 0.8em; font-weight: 600;
        `;
        td3.appendChild(badge);
        
        const td4 = document.createElement('td'); td4.textContent = formatAmount(t.amount); 
        td4.style.color = isExpense ? 'var(--danger)' : 'var(--accent2)';
        td4.style.fontWeight = '700';

        const td5 = document.createElement('td');
        const editBtn = document.createElement('button');
        editBtn.className = 'btn secondary action-small';
        editBtn.innerHTML = '<i class="fa fa-edit"></i>';
        editBtn.onclick = () => openTransactionModal(t.id);
        td5.appendChild(editBtn);

        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
        tbody.appendChild(tr);
    });
    
    // 3. Vykreslení celkového zůstatku a indikátoru
    const balanceEl = $('totalBalance');
    const upcomingSumEl = $('upcomingPaymentsSum');
    const upcomingAmountTextEl = $('upcomingAmountText');
    
    balanceEl.textContent = formatAmount(totalBalance); 
    balanceEl.style.color = totalBalance >= 0 ? 'var(--accent2)' : 'var(--danger)';
    
    // Oranžový indikátor trvalých plateb
    if (upcomingPaymentsTotal > 0) {
        upcomingAmountTextEl.textContent = formatAmount(upcomingPaymentsTotal);
        upcomingSumEl.style.display = 'inline-flex';
        // Změna barvy zůstatku na žlutou, pokud je zůstatek > 0, ale po odečtení by byl záporný
        if (totalBalance > 0 && (totalBalance - upcomingPaymentsTotal) < 0) {
            balanceEl.style.color = '#ff9900';
        }
    } else {
        upcomingSumEl.style.display = 'none';
    }


    document.querySelector('#mainTable thead th:nth-child(4)').textContent = 'Částka (' + store.currency + ')';
}

function applyFilter(){
    const f = $('filterFrom').value ? new Date($('filterFrom').value) : new Date(0); 
    const t = $('filterTo').value ? new Date($('filterTo').value) : new Date();
    
    let filterToDate = t;
    if ($('filterTo').value) {
        filterToDate = new Date($('filterTo').value);
        filterToDate.setDate(filterToDate.getDate() + 1); 
        filterToDate.setSeconds(filterToDate.getSeconds() - 1); 
    } else {
        filterToDate.setDate(filterToDate.getDate() + 1);
        filterToDate.setSeconds(filterToDate.getSeconds() - 1);
    }
    
    let filtered = store.transactions.filter(t => {
        const date = new Date(t.date);
        return date >= f && date <= filterToDate;
    });
    
    const sel = $('sortSelect').value;
    if(sel==='date_desc'){ filtered.sort((a,b)=> new Date(b.date) - new Date(a.date)); }
    if(sel==='date_asc'){ filtered.sort((a,b)=> new Date(a.date) - new Date(b.date)); }
    if(sel==='amount_desc'){ 
        filtered.sort((a,b)=> {
            return b.amount - a.amount;
        });
    }
    
    renderTransactionTable(filtered);
    // Aktualizovat i sekci cílů s platbami, které závisí na filtru
    if(document.querySelector('.footer-nav button[data-section="goals"]').classList.contains('active')) renderRecurringPaymentsGoalSection();
    
    // Spustíme computeStats pouze pokud je sekce aktivní
    if(document.querySelector('.footer-nav button[data-section="stats"]').classList.contains('active')) computeStats();
    
    // DŮLEŽITÉ: Aktualizace Správy trvalých plateb při změně filtru
    if(document.querySelector('.footer-nav button[data-section="settings"]').classList.contains('active')) renderRecurringPaymentsManagement();

}

function applySort(){
    applyFilter(); 
}

function computeStats(){
    const f = $('filterFrom').value ? new Date($('filterFrom').value) : new Date(0);
    const t = $('filterTo').value ? new Date($('filterTo').value) : new Date();
    
    let filterToDate = t;
    if ($('filterTo').value) {
        filterToDate = new Date($('filterTo').value);
        filterToDate.setDate(filterToDate.getDate() + 1); 
        filterToDate.setSeconds(filterToDate.getSeconds() - 1); 
    } else {
        filterToDate.setDate(filterToDate.getDate() + 1);
        filterToDate.setSeconds(filterToDate.getSeconds() - 1);
    }

    let totalIncome = 0;
    let totalExpense = 0;
    const categoryTotals = {}; 

    const filtered = store.transactions.filter(t => {
        const date = new Date(t.date);
        return date >= f && date <= filterToDate;
    });

    filtered.forEach(t => {
        if(t.type === 'income'){
            totalIncome += t.amount;
        } else {
            totalExpense += t.amount;
        }
        
        const catName = t.category || 'Nezadáno';
        if(!categoryTotals[catName]){
            categoryTotals[catName] = { amount: 0, type: t.type };
        }
        categoryTotals[catName].amount += t.amount;
    });

    const totalBalance = totalIncome - totalExpense;

    $('statBalance').textContent = formatAmount(totalBalance);
    $('statBalance').style.color = totalBalance >= 0 ? 'var(--accent2)' : 'var(--danger)';
    $('statIncome').textContent = formatAmount(totalIncome);
    $('statExpense').textContent = formatAmount(totalExpense);

    const catCont = $('categoryStats'); catCont.innerHTML = '';
    const sortedCats = Object.keys(categoryTotals).map(name => ({
        name,
        ...categoryTotals[name],
    })).sort((a, b) => b.amount - a.amount);
    
    sortedCats.forEach(cat => {
        const card = document.createElement('div'); 
        card.className=`stat-card ${cat.type === 'income' ? 'income' : 'expense'}`;
        
        const total = cat.type === 'income' ? totalIncome : totalExpense;
        const percentage = total > 0 ? ((cat.amount / total) * 100).toFixed(1) : 0;

        card.innerHTML = `
            <div class="muted">${cat.name} (${cat.type === 'income' ? 'Příjem' : 'Výdaj'})</div>
            <div class="value" style="color:${cat.type === 'income' ? 'var(--accent2)' : 'var(--danger)'}">${formatAmount(cat.amount)}</div>
            <div class="muted" style="margin-top:4px; font-weight:700">${percentage}% celku</div>
        `;
        catCont.appendChild(card);
    });
}

function renderHistory(){
    const listCont = $('historyList');
    listCont.innerHTML = '';
    
    const today = new Date();
    const monthlyStats = {};
    let maxAmount = 0;

    // 1. Sběr dat za posledních 12 měsíců
    for (let i = 0; i < 12; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = date.getMonth();
        const key = `${year}-${month.toString().padStart(2, '0')}`;
        const monthName = ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen", "Červenec", "Srpen", "Září", "Říjen", "Listopad", "Prosinec"][month];
        
        const dateFrom = new Date(year, month, 1);
        const dateTo = new Date(year, month + 1, 0); 
        dateTo.setHours(23, 59, 59, 999); 

        let totalIncome = 0;
        let totalExpense = 0;

        store.transactions.forEach(t => {
            const tDate = new Date(t.date);
            if (tDate >= dateFrom && tDate <= dateTo) {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            }
        });

        monthlyStats[key] = {
            name: `${monthName} ${year}`,
            income: totalIncome,
            expense: totalExpense,
            balance: totalIncome - totalExpense,
        };
        // Max Amount je v přepočtu na CZK pro správné srovnání
        const incCZK = store.currency === 'EUR' ? totalIncome * store.exchangeRate : totalIncome;
        const expCZK = store.currency === 'EUR' ? totalExpense * store.exchangeRate : totalExpense;
        
        maxAmount = Math.max(maxAmount, incCZK, expCZK);
    }
    
    // 2. Vykreslení karet s grafy (OPRAVA BODU 4)
    Object.keys(monthlyStats).sort().reverse().forEach(key => {
        const stats = monthlyStats[key];
        const card = document.createElement('div');
        card.className = 'history-month-card card';
        
        const balanceColor = stats.balance >= 0 ? 'var(--accent2)' : 'var(--danger)';
        
        // Výpočet výšek pro graf (používáme maxAmount v CZK pro konzistentní výšku sloupce)
        const incomeValueForMax = store.currency === 'EUR' ? stats.income * store.exchangeRate : stats.income;
        const expenseValueForMax = store.currency === 'EUR' ? stats.expense * store.exchangeRate : stats.expense;

        const incomeHeight = maxAmount > 0 ? (incomeValueForMax / maxAmount) * 100 : 0;
        const expenseHeight = maxAmount > 0 ? (expenseValueForMax / maxAmount) * 100 : 0;
        
        card.innerHTML = `
            <h4>${stats.name}</h4>
            <div class="history-stat-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <div>Příjmy: <strong style="color:var(--accent2)">${formatAmount(stats.income)}</strong></div>
                <div>Výdaje: <strong style="color:var(--danger)">${formatAmount(stats.expense)}</strong></div>
                <div style="grid-column: 1 / span 2;">Bilance: <strong style="color:${balanceColor}">${formatAmount(stats.balance)}</strong></div>
            </div>
            
            <div class="chart-container" style="display:flex; height:100px; gap:10px; margin-top:15px; align-items:flex-end; border-bottom:1px solid var(--border);">
                <div class="chart-bar-wrap" style="height:100%; display:flex; flex-direction:column-reverse; align-items:center; flex-grow:1; min-width:40px;">
                    <div class="chart-bar income" style="width: 25px; background: var(--accent2); height: ${incomeHeight}%; transition:height 0.5s; border-radius:3px 3px 0 0;"></div>
                    <div class="chart-label muted" style="font-size:0.7em; margin-bottom:5px;">${stats.income > 0 ? Math.round(stats.income / 1000) + 'tis.' : ''}</div>
                </div>
                <div class="chart-bar-wrap" style="height:100%; display:flex; flex-direction:column-reverse; align-items:center; flex-grow:1; min-width:40px;">
                    <div class="chart-bar expense" style="width: 25px; background: var(--danger); height: ${expenseHeight}%; transition:height 0.5s; border-radius:3px 3px 0 0;"></div>
                    <div class="chart-label muted" style="font-size:0.7em; margin-bottom:5px;">${stats.expense > 0 ? Math.round(stats.expense / 1000) + 'tis.' : ''}</div>
                </div>
            </div>
            <div class="muted" style="text-align:center; font-size:0.8em; margin-top:5px;">Příjmy / Výdaje (Tis. ${store.currency})</div>
        `;
        listCont.appendChild(card);
    });
}


function clearAll(){
    if(confirm('POZOR: Opravdu chcete smazat VŠECHNA data (transakce, cíle, kategorie, karty)? Tato akce je nevratná.')){
        localStorage.clear();
        alert('Všechna data byly smazána. Aplikace se obnoví.');
        window.location.reload();
    }
}

function exportAllJSON(){
    const data = JSON.stringify(store, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'financni_planovac_export_' + new Date().toISOString().slice(0, 10) + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importAllJSON(event){
    const file = event.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedStore = JSON.parse(e.target.result);
            if(confirm('Opravdu chcete importovat tato data? PŘEPÍŠÍ AKTUÁLNÍ DATA.')){
                localStorage.setItem(LS_TRANSACTIONS, JSON.stringify(importedStore.transactions || []));
                localStorage.setItem(LS_GOALS, JSON.stringify(importedStore.goals || []));
                localStorage.setItem(LS_CATEGORIES, JSON.stringify(importedStore.categories || []));
                localStorage.setItem(LS_CARDS, JSON.stringify(importedStore.cards || [])); 
                localStorage.setItem(LS_RECURRING_PAYMENTS, JSON.stringify(importedStore.recurringPayments || [])); // Nový import
                localStorage.setItem(LS_CURRENCY, importedStore.currency || 'CZK');
                localStorage.setItem(LS_EXCHANGE_RATE, importedStore.exchangeRate || 1);
                
                alert('Data úspěšně importována. Aplikace se obnoví.');
                window.location.reload();
            }
        } catch (error) {
            alert('Chyba při nahrávání souboru. Ujistěte se, že se jedná o platný JSON soubor. Chyba: ' + error.message);
        }
    };
    reader.readAsText(file);
}

function exportCSV() {
    let csv = 'Datum;Popis;Typ;Částka (' + store.currency + ');Kategorie\n';
    currentTransactions.forEach(t => {
        const amountDisplay = t.amount; 
        csv += `${t.date};"${t.desc.replace(/"/g, '""')}";${t.type === 'income' ? 'Příjem' : 'Výdaj'};${t.amount.toString().replace('.', ',')};${t.category || 'Nezadáno'}\n`;
    });

    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' }); 
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'financni_planovac_export_transakci.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/* redraw / orchestrace */
function redrawAll(){
  loadStore();
  fetchExchangeRate(); 
  
  renderMonthOptions(); 
  
  const now = new Date();
  if(!$('transactionDate').value) $('transactionDate').value = now.toISOString().slice(0,10);
  
  $('currencySelect').value = store.currency; 

  renderCategories(); 
  renderGoals(); 
  renderCards(); 
  fillRecurringDaySelects(); // Inicializace dnů
  
  // Zobrazení defaultní sekce a aktivace nav tlačítka
  document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
  $('section-budget').style.display = 'block';
  document.querySelector('.footer-nav button[data-section="budget"]').classList.add('active');

  applyFilter(); 
  
  const currentTheme = localStorage.getItem('theme') || 'light'; 
  document.body.setAttribute('data-theme', currentTheme);
  updateThemeButton(currentTheme);
}


/* theme toggling */
function toggleTheme(){
  const body = document.body;
  const t = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
  body.setAttribute('data-theme', t);
  localStorage.setItem('theme', t); 
  updateThemeButton(t);
}

function updateThemeButton(theme){
    const btn = $('themeBtn');
    if(!btn) return;
    if(theme === 'dark'){
        btn.innerHTML = '<i class="fa fa-sun"></i>';
    } else {
        btn.innerHTML = '<i class="fa fa-moon"></i>';
    }
}

// Odstraněno resize listener a mousemove listener, jelikož se starfield nepoužívá.


/* init */
(function init(){
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.body.setAttribute('data-theme', savedTheme);
  
  redrawAll();
})();
</script>

</body>
</html>

