<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Finanční Portál - Osobní Rozpočet a Investice</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  /* ========================================================
     BANKING THEME VARIABLES - MODIFIKOVÁNO pro Revolut vzhled
     ======================================================== */
  :root{
    --bg: #f0f2f5; /* Světle šedé pozadí */
    --card: #ffffff;
    --muted: #6c757d; 
    --accent: #007bff; /* Primární bankovní modrá (Safír) */
    --accent2: #28a745; /* Zelená pro příjmy/zisky */
    --glass: rgba(255,255,255,0.7);
    --border: rgba(0,0,0,0.08);
    --text: #212529; 
    --danger: #dc3545; /* Červená pro výdaje/ztráty */
    --shadow: 0 6px 20px rgba(0,123,255,0.1); /* Modřejší, výraznější stín */
  }
  /* ÚPRAVA ČERNÉHO REŽIMU */
  [data-theme='dark']{
    --bg: #1c2128; /* Tmavé pozadí */
    --card: #282d35; /* Tmavší karta */
    --muted: #adb5bd;
    --accent: #4da6ff; /* Světlejší bankovní modrá */
    --accent2: #38c156; /* Světlejší zelená */
    --glass: rgba(0,0,0,0.4);
    --border: rgba(255,255,255,0.12);
    --text: #f8f9fa;
    --danger: #ff6b6b;
    --shadow: 0 6px 20px rgba(0,0,0,0.4); 
  }

  /* RESET A ZÁKLADNÍ TYPOGRAFIE */
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family: 'Inter', "Segoe UI", Tahoma, sans-serif;
    background: var(--bg); 
    color: var(--text);
    padding-bottom:40px;
    transition:all .3s ease-in-out; 
    position:relative;
    overflow-x:hidden;
    touch-action: pan-y;
  }
  [data-theme='dark'] body{ background: var(--bg); } 

  /* Starfield ztlumení */
  #starfield { opacity: 0.05; transition: opacity 0.4s ease; }
  [data-theme='dark'] #starfield { opacity: 0.1; }

  /* Záhlaví - Profesionální a čisté */
  header{
    position: sticky; top: 0; z-index: 10; 
    background: var(--card); 
    border-bottom: 3px solid var(--accent); /* Výraznější podtržení */
    padding:16px 18px; /* Menší svislý padding */
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
    color: var(--text);
  }

  .title h1{ font-size:20px; margin-bottom:2px; font-weight:800; }
  .title .sub{ font-size:12px; color:var(--muted); font-weight:500; }

  /* ========================================================
     3. ROVINY A RESPONZIVITA - Zajištění stejné roviny
     ======================================================== */
  .wrap{max-width:1200px;margin:20px auto;padding:0 12px; position:relative; z-index:5} /* Menší padding na mobilu */
  .card{
    background:var(--card); border-radius:16px; /* Více zaoblené */
    padding:20px;
    box-shadow: var(--shadow); 
    border:1px solid var(--border);
    transition: transform .25s ease, box-shadow .25s ease, background .3s;
    overflow: hidden; 
  }
  .card + .card{ margin-top:16px }
  .stat-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 12px;
    margin-top: 16px;
  }

  /* TOPBAR A FILTRY */
  .topbar{display:flex;flex-direction:column;gap:16px;margin-bottom:16px}
  .filter-bar{display:flex;gap:12px;align-items:center; flex-wrap:wrap;}
  .filter-item{display:flex;gap:8px;align-items:center; padding:8px 12px; border-radius:10px; background:var(--bg)}
  .form-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px; }

  /* ========================================================
     1. POSUVNÁ NAVIGACE (RADEK)
     ======================================================== */
  .nav{ 
    display:flex; 
    gap:8px; 
    background:var(--bg);
    padding:6px; 
    border-radius:12px; 
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    /* KLÍČOVÉ PRO POSUV */
    overflow-x: auto; 
    white-space: nowrap;
    -webkit-overflow-scrolling: touch; /* iOS plynulé scroll */
    scrollbar-width: none; /* Skryje scrollbar */
  }
  .nav::-webkit-scrollbar { display: none; } /* Skryje scrollbar pro Webkit */
  
  .nav button{ 
    background:transparent; 
    border:none; 
    padding:10px 16px; 
    border-radius:10px; 
    cursor:pointer; 
    color:var(--muted); 
    font-weight:700; 
    transition: all .2s;
    min-width: max-content; /* Zabrání zmenšení tlačítek */
  }
  .nav button.active{ 
    background:var(--accent); 
    color:#fff; 
    box-shadow: 0 4px 8px rgba(0,123,255,0.2);
    transform: translateY(-1px);
  }
  [data-theme='dark'] .nav{ background: #1f242c; }


  /* Formuláře, Tlačítka, Tabulky - Vizuál Revolut */
  input[type=text], input[type=date], input[type=number], select, textarea{
    padding:12px 14px; 
    border-radius:10px; 
    border:1px solid var(--border); 
    min-width:180px; 
    background:var(--bg); 
    color:var(--text);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
    flex-grow: 1; /* Pomůže s responzivitou */
  }
  .btn{ 
    padding:12px 18px; 
    border-radius:10px; 
    background:var(--accent); 
    font-weight:700; 
    transition: background .2s, transform .1s, box-shadow .2s;
    box-shadow: 0 2px 4px rgba(0,123,255,0.2);
  }
  .btn:hover{ background: #0069d9; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }

  /* Tabulka - čistá a přehledná */
  .table-wrap{ overflow-x: auto; margin-top:16px; }
  table.main{ width: 100%; min-width: 600px; border-collapse: collapse; } 
  table.main thead th{ 
    text-align:left; padding:15px 12px; 
    background:var(--accent); 
    color:#fff; 
    font-weight:800; 
    font-size:0.9em; 
    border-right:1px solid rgba(255,255,255,0.1);
  }
  table.main tbody td{ padding:12px; border-bottom:1px solid var(--border); vertical-align:middle; }
  .action-small{ padding: 8px 12px; font-size: 0.8em; }

  /* ========================================================
     4. SPRÁVA KATEGORIÍ - Vylepšený Tag vzhled
     ======================================================== */
  .category-tag {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 20px; /* Pilulka tvar */
    font-weight: 600;
    font-size: 0.9em;
    cursor: default;
    transition: all .2s;
    border: 1px solid transparent;
  }
  .category-tag.expense { 
    background: rgba(220,53,69,0.15); 
    color: var(--danger);
    border-color: rgba(220,53,69,0.25);
  }
  .category-tag.income { 
    background: rgba(40,167,69,0.15); 
    color: var(--accent2);
    border-color: rgba(40,167,69,0.25);
  }
  .category-tag i.fa-times {
    cursor: pointer;
    font-size: 0.9em;
    opacity: 0.7;
  }
  .category-tag i.fa-times:hover { opacity: 1; }

  /* ========================================================
     2. PŘEHLED MĚSÍCŮ S GRAFY
     ======================================================== */
  .history-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 16px;
  }
  .history-month-card {
      background: var(--card);
      border-radius: 12px;
      padding: 15px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all .2s;
  }
  .history-month-card h4 {
      margin-bottom: 12px;
      font-weight: 800;
      color: var(--accent);
  }
  .history-stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 0.9em;
      margin-bottom: 15px;
  }
  .chart-container {
      height: 100px;
      display: flex;
      gap: 8px;
      align-items: flex-end;
      padding-top: 5px;
  }
  .chart-bar-wrap {
      width: 50%;
      height: 100%;
      display: flex;
      flex-direction: column-reverse;
      align-items: center;
      position: relative;
  }
  .chart-bar {
      width: 100%;
      background: var(--border);
      border-radius: 4px 4px 0 0;
      transition: height 0.5s ease-out;
      position: relative;
  }
  .chart-bar.income { background: var(--accent2); }
  .chart-bar.expense { background: var(--danger); }
  .chart-label {
      font-size: 0.75em;
      color: var(--muted);
      position: absolute;
      top: -15px;
  }


  /* MEDIA QUERIES pro mobilní zařízení */
  @media(max-width:992px){ 
    .wrap{ margin-top:16px; padding:0 12px; }
    header{ padding:12px 12px; }
    .title h1{ font-size:18px; }
    .title .sub{ display:none; } /* Skryjeme sub-titulek na mobilu */
    .filter-item{ flex-grow:1; } /* Filtry zaberou celou šířku */
    .filter-bar{ flex-direction:column; align-items:stretch; }
    input[type=date], select{ min-width:unset; }
    .topbar > div:last-child{ flex-direction:column; align-items:stretch; }
    .stat-list { grid-template-columns: 1fr; } /* Statistiky pod sebe */
  }

  /* MODAL */
  .modal-overlay{
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:99;
    display:flex;justify-content:center;align-items:center;
  }
  .modal-content{
    background:var(--card); border-radius:16px; 
    padding:30px; 
    max-width:90%; /* Zajištění mobilního zobrazení */
    width:550px; 
    box-shadow:0 30px 60px rgba(0,0,0,0.4); 
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal-footer{ border-top:1px solid var(--border); padding-top:20px; margin-top:20px; }
</style>
</head>
<body data-theme="light">

<canvas id="starfield"></canvas>

<header>
  <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;width:100%">
    <div class="title">
      <h1><i class="fa fa-university" style="color:var(--accent)"></i> <span style="color:var(--accent)">E</span>-Finanční Portál</h1>
      <div class="sub muted">Osobní bankovnictví a rozpočtový přehled</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end">
      <div id="exchangeRateDisplay" class="muted" style="font-size:0.8em; margin-bottom:4px; font-weight:600;">Kurz: 1 € ≈ 0.00 Kč</div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="currencySelect" onchange="changeCurrency()" style="padding:10px; border-radius:10px; font-weight:700;">
            <option value="CZK">Kč (CZK)</option>
            <option value="EUR">€ (EUR)</option>
        </select>
        <div id="todayShort" class="muted" style="font-weight:600; display:none;"></div>
        <button class="btn secondary" onclick="toggleTheme()" id="themeBtn"><i class="fa fa-moon"></i> Režim</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <div class="topbar">
    <div class="nav card" role="navigation" aria-label="Sekce" style="padding: 0; background: none; box-shadow: none; border: none;">
      <div class="nav" style="box-shadow: var(--shadow); border: 1px solid var(--border); padding: 8px;">
        <button class="active" data-section="budget" onclick="showSection(event)"><i class="fa fa-wallet"></i> Účet</button>
        <button data-section="goals" onclick="showSection(event)"><i class="fa fa-piggy-bank"></i> Spoření & Investice</button>
        <button data-section="stats" onclick="showSection(event)"><i class="fa fa-chart-line"></i> Analýza</button>
        <button data-section="history" onclick="showSection(event)"><i class="fa fa-history"></i> Přehled měsíců</button>
        <button data-section="settings" onclick="showSection(event)"><i class="fa fa-cog"></i> Správa</button>
      </div>
    </div>

    <div class="filter-bar">
      <div class="filter-item">
        <div class="muted">Měsíc:</div>
        <select id="monthSelect" onchange="applyMonthFilter()" style="min-width:160px"></select>
      </div>
      <div class="filter-item">
        <div class="muted">Období: Od</div>
        <input type="date" id="filterFrom" style="min-width:120px"/>
        <div class="muted">Do</div>
        <input type="date" id="filterTo" style="min-width:120px"/>
        <button class="btn secondary" onclick="applyFilter()"><i class="fa fa-filter"></i> Filtr</button>
      </div>
    </div>
  </div>
  
  <section id="section-budget">
    <div class="card">
      <div>
        <h2><i class="fa fa-exchange-alt" style="color:var(--accent)"></i> Nová Transakce</h2>
        <div class="muted">Zadejte detail platby nebo příjmu.</div>
      </div>

      <div class="form-row" style="margin-top:20px">
        <input type="date" id="transactionDate" />
        <input type="text" id="transactionDesc" placeholder="Popis (např. 'Příchozí platba' nebo 'Lidl')"/>
        <input type="number" id="transactionAmount" placeholder="Částka (např. 1500)"/>
        <select id="transactionType">
          <option value="expense">Platba / Výdaj</option>
          <option value="income">Přijatá platba / Příjem</option>
        </select>
        <select id="transactionCategory"></select>
        <button class="btn" id="addTransactionBtn" onclick="addTransaction()"><i class="fa fa-plus-square"></i> Provedení transakce</button>
      </div>
    </div>

    <div class="card" id="transactionCard">
      <div style="display:flex;justify-content:space-between;align-items:center; flex-wrap:wrap; gap:10px;">
        <div>
          <h3 class="muted"><i class="fa fa-receipt"></i> Detailní Přehled Transakcí</h3>
          <div class="muted">Všechny platby a pohyby pro vybrané období.</div>
        </div>
        <div class="muted" style="font-size:1.1em;">
          Celkový **Zůstatek**: <span id="totalBalance" style="font-weight:900; font-size:1.3em;">0 Kč</span>
        </div>
      </div>

      <div class="table-wrap">
        <table class="main" id="mainTable">
          <thead>
            <tr><th>Datum</th><th>Popis a Kategorie</th><th>Typ</th><th>Částka</th><th>Akce</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="exports" style="display:flex;justify-content:space-between; margin-top:15px; flex-wrap:wrap; gap:10px;">
        <div style="display:flex;gap:8px">
          <button class="btn secondary" onclick="exportCSV()"><i class="fa fa-file-csv"></i> Export CSV</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div class="muted">Řadit:</div>
          <select id="sortSelect" onchange="applySort()">
            <option value="date_desc">Datum (nejnovější)</option>
            <option value="date_asc">Datum (nejstarší)</option>
            <option value="amount_desc">Částka (největší)</option>
          </select>
        </div>
      </div>
    </div>
  </section>
  
  <section id="section-goals" style="display:none">
    <div class="card">
      <h2><i class="fa fa-hand-holding-usd"></i> Spořicí Cíle</h2>
      <div class="muted">Sledujte svůj pokrok v ukládání peněz.</div>
      <div style="margin-top:12px">
        <div class="form-row">
            <input type="text" id="newGoalName" placeholder="Název cíle (např. 'Nové bydlení')" style="flex-grow:1"/>
            <input type="number" id="newGoalTarget" placeholder="Cílová částka"/>
            <input type="number" id="newGoalSaved" placeholder="Aktuálně naspořeno"/>
            <button class="btn" onclick="addGoal()"><i class="fa fa-plus-circle"></i> Vytvořit cíl</button>
        </div>
        <div id="goalsList" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <section id="section-stats" style="display:none">
    <div class="card">
      <h2><i class="fa fa-chart-pie"></i> Finanční Analýza</h2>
      <div class="muted">Statistiky a souhrn pro aktuální období filtru (výše).</div>

      <div class="stat-list" id="statCards">
        <div class="stat-card balance">
            <div class="muted">Zůstatek (Příjmy - Výdaje)</div>
            <div class="value" id="statBalance">0 Kč</div>
        </div>
        <div class="stat-card income">
            <div class="muted">Celkové Příjmy</div>
            <div class="value" id="statIncome">0 Kč</div>
        </div>
        <div class="stat-card expense">
            <div class="muted">Celkové Výdaje</div>
            <div class="value" id="statExpense">0 Kč</div>
        </div>
      </div>
      
      <h3 style="margin-top:25px"><i class="fa fa-tags"></i> Rozdělení podle kategorií</h3>
      <p class="muted">Kolik peněz šlo na jednotlivé kategorie (pro filtrované období).</p>
      
      <div id="categoryStats" class="stat-list" style="margin-top:12px">
          </div>
    </div>
  </section>
  
  <section id="section-history" style="display:none">
    <div class="card">
        <h2><i class="fa fa-calendar-alt"></i> Měsíční Historie a Grafy</h2>
        <div class="muted">Přehled hospodaření za minulých 12 měsíců.</div>
        <div id="historyList" class="history-list">
            </div>
    </div>
  </section>

  <section id="section-settings" style="display:none">
    <div class="card">
      <h2><i class="fa fa-wrench"></i> Správa kategorií</h2>
      <p class="muted">Přidejte nebo upravte kategorie pro přesnější přehled.</p>
      
      <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;border:1px solid var(--border);padding:15px;border-radius:12px;background:var(--bg)">
        <select id="categoryType">
          <option value="expense">Výdajová</option>
          <option value="income">Příjmová</option>
        </select>
        <input type="text" id="newCategoryName" placeholder="Název kategorie (např. 'Káva')" style="flex-grow:1"/>
        <button class="btn" onclick="addCategory()"><i class="fa fa-plus"></i> Přidat</button>
      </div>

      <div id="categoryList" style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;">
        </div>

    </div>

    <div class="card">
      <h2><i class="fa fa-database"></i> Databáze</h2>
      <p class="muted">Možnosti zálohování, obnovení a smazání dat.</p>

      <div style="margin-top:10px;display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn" onclick="exportAllJSON()"><i class="fa fa-download"></i> Exportovat data (JSON)</button>
        
        <input type="file" id="importJsonFile" accept=".json" style="display:none;" onchange="importAllJSON(event)">
        <button class="btn secondary" onclick="document.getElementById('importJsonFile').click()"><i class="fa fa-upload"></i> Nahrát JSON data</button>
        <button class="btn danger" onclick="clearAll()"><i class="fa fa-trash"></i> Smazat VŠECHNA data</button>
      </div>
    </div>
  </section>

</main>

<div id="transactionModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h2 id="modalTransactionTitle" style="margin-bottom:20px">Úprava Transakce</h2>
        <div class="form-row">
            <input type="date" id="modalTDate" />
            <input type="text" id="modalTDesc" placeholder="Popis transakce"/>
            <input type="number" id="modalTAmount" placeholder="Částka"/>
            <select id="modalTType">
              <option value="expense">Platba / Výdaj</option>
              <option value="income">Přijatá platba / Příjem</option>
            </select>
            <select id="modalTCategory"></select>
        </div>
        <div class="modal-footer" style="display:flex;justify-content:space-between">
            <button class="btn danger" id="modalDeleteBtn"><i class="fa fa-trash"></i> Smazat</button>
            <button class="btn" onclick="saveTransactionProfile()"><i class="fa fa-save"></i> Uložit Změny</button>
        </div>
        <button class="btn secondary" onclick="closeModal('transactionModal')" style="width:100%; margin-top:10px;"><i class="fa fa-times"></i> Zavřít</button>
    </div>
</div>

<div id="goalModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h2 id="modalGoalTitle" style="margin-bottom:20px">Úprava Cíle</h2>
        <div class="form-row">
            <input type="text" id="modalGoalName" placeholder="Název cíle" style="flex-grow:1"/>
            <input type="number" id="modalGoalTarget" placeholder="Cílová částka"/>
            <input type="number" id="modalGoalSaved" placeholder="Aktuálně naspořeno" disabled title="Spravováno přes investice níže"/>
        </div>
        
        <h3 style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;"><i class="fa fa-plus"></i> Přidat Investici</h3>
        <p class="muted">Přidejte částku, která se zároveň odečte z vašeho rozpočtu.</p>
        <div class="form-row">
            <input type="date" id="modalInvestDate" style="flex-basis: 150px;"/>
            <input type="number" id="modalInvestAmount" placeholder="Částka k investování"/>
            <button class="btn income" onclick="addInvestmentFromModal()"><i class="fa fa-plus-circle"></i> Investovat</button>
        </div>

        <div class="modal-footer" style="display:flex;justify-content:space-between">
            <button class="btn danger" id="modalGoalDeleteBtn"><i class="fa fa-trash"></i> Smazat Cíl</button>
            <button class="btn" onclick="saveGoalProfile()"><i class="fa fa-save"></i> Uložit Cíl</button>
        </div>
        <button class="btn secondary" onclick="closeModal('goalModal')" style="width:100%; margin-top:10px;"><i class="fa fa-times"></i> Zavřít</button>
    </div>
</div>

<script>
// Váš PŮVODNÍ JAVASCRIPT KÓD JE ZACHOVÁN
// Následují POUZE modifikace/doplnění pro body 2 a 4.

/* =========================
   Storage & data model
   ========================= */
const LS_TRANSACTIONS = 'finance_transactions_v1';
const LS_GOALS = 'finance_goals_v1';
const LS_CATEGORIES = 'finance_categories_v1'; 
const LS_CURRENCY = 'finance_currency_v1';
const LS_EXCHANGE_RATE = 'finance_exchange_rate_v1';

let store = {
  transactions: [], 
  goals: [],        
  categories: [],   
  currency: 'CZK',
  exchangeRate: 1, 
};

function loadStore(){
  try{
    const rawT = localStorage.getItem(LS_TRANSACTIONS);
    if(rawT) store.transactions = JSON.parse(rawT).map(t => ({
      ...t, 
      id: t.id || Math.random().toString(36).substring(2, 9) 
    }));
    else store.transactions = [];

    const rawG = localStorage.getItem(LS_GOALS);
    if(rawG) store.goals = JSON.parse(rawG).map(g => ({
        ...g, 
        id: g.id || Math.random().toString(36).substring(2, 9)
    }));
    else store.goals = [];

    const rawC = localStorage.getItem(LS_CATEGORIES);
    if(rawC) store.categories = JSON.parse(rawC);
    
    // Zajištění výchozích kategorií
    if(!store.categories || store.categories.length === 0) {
        store.categories = [
            { name: 'Nezadáno', type: 'expense' },
            { name: 'Jídlo', type: 'expense' },
            { name: 'Nájem/Bydlení', type: 'expense' },
            { name: 'Volný čas', type: 'expense' },
            { name: 'Investice', type: 'expense' },
            { name: 'Výplata', type: 'income' },
            { name: 'Bonus', type: 'income' },
        ];
    }
    
    const rawCurrency = localStorage.getItem(LS_CURRENCY);
    store.currency = rawCurrency || 'CZK';
    $('currencySelect').value = store.currency;
    
    const rawRate = localStorage.getItem(LS_EXCHANGE_RATE);
    store.exchangeRate = parseFloat(rawRate) || 1;


  }catch(e){
    console.warn('Load error',e);
    store.transactions = [];
    store.goals = [];
    store.categories = [ { name: 'Nezadáno', type: 'expense' } ];
    store.currency = 'CZK';
    store.exchangeRate = 1;
  }
}
function saveStore(){
  localStorage.setItem(LS_TRANSACTIONS, JSON.stringify(store.transactions));
  localStorage.setItem(LS_GOALS, JSON.stringify(store.goals));
  localStorage.setItem(LS_CATEGORIES, JSON.stringify(store.categories));
  localStorage.setItem(LS_CURRENCY, store.currency);
  localStorage.setItem(LS_EXCHANGE_RATE, store.exchangeRate.toFixed(4));
}

/* helpers */
function $(id){return document.getElementById(id)}
function closeModal(id){ $(id).style.display = 'none'; currentTransaction = null; currentGoal = null; }

function formatDate(d){ 
    if(!d) return '';
    const dt = new Date(d); 
    if(isNaN(dt.getTime())) { return d; }
    return dt.toLocaleDateString('cs-CZ'); 
}
function formatAmount(amount, currencyCode = store.currency){
    let finalAmount = amount;
    let code = 'CZK';
    let locale = 'cs-CZ';

    if (currencyCode === 'EUR') {
        finalAmount = amount / store.exchangeRate;
        code = 'EUR';
        locale = 'de-DE';
    } else { // CZK
        code = 'CZK';
        locale = 'cs-CZ';
    }

    return new Intl.NumberFormat(locale, { style: 'currency', currency: code }).format(finalAmount);
}
function todayShort(){ const n = new Date(); $('todayShort').textContent = n.toLocaleDateString('cs-CZ'); }


/* MĚNA A KURZ */
function fetchExchangeRate(){
    const simulatedRate = 24.50; 
    store.exchangeRate = simulatedRate;
    saveStore();
    $('exchangeRateDisplay').textContent = `Kurz: 1 € ≈ ${store.exchangeRate.toFixed(2)} Kč`;
}

function changeCurrency(){
    store.currency = $('currencySelect').value;
    saveStore();
    applyFilter();
    renderGoals();
    if(document.querySelector('.nav button[data-section="stats"]').classList.contains('active')) computeStats();
    if(document.querySelector('.nav button[data-section="history"]').classList.contains('active')) renderHistory();
}


/* nav */
function showSection(e){
  const btn = e.currentTarget;
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const sec = btn.getAttribute('data-section');
  document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
  $('section-'+sec).style.display = '';
  
  if(sec === 'stats') computeStats();
  if(sec === 'goals') renderGoals();
  if(sec === 'history') renderHistory();
  if(sec === 'settings') renderCategories(); 
}

/* MĚSÍČNÍ FILTR */
function applyMonthFilter() {
    const selected = $('monthSelect').value;
    if (selected === 'custom') {
        $('filterFrom').disabled = false;
        $('filterTo').disabled = false;
    } else {
        const [year, month] = selected.split('-');
        const dateFrom = new Date(year, month - 1, 1);
        const dateTo = new Date(year, month, 0); 

        $('filterFrom').value = dateFrom.toISOString().slice(0, 10);
        $('filterTo').value = dateTo.toISOString().slice(0, 10);
        
        $('filterFrom').disabled = true;
        $('filterTo').disabled = true;
    }
    applyFilter();
}

function renderMonthOptions() {
    const select = $('monthSelect');
    select.innerHTML = '';

    const today = new Date();
    const options = [];
    const monthNames = ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen", "Červenec", "Srpen", "Září", "Říjen", "Listopad", "Prosinec"];

    for (let i = 0; i < 12; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const monthStr = month.toString().padStart(2, '0');
        const value = `${year}-${monthStr}`;
        const label = `${monthNames[date.getMonth()]} ${year}`;
        
        options.push({ value, label });
    }
    
    options.reverse().forEach((opt, index) => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        if (index === options.length - 1) { 
            option.selected = true;
        }
        select.appendChild(option);
    });

    const customOption = document.createElement('option');
    customOption.value = 'custom';
    customOption.textContent = 'Vlastní období...';
    select.appendChild(customOption);
    
    applyMonthFilter(); 
}


/* ========================================================
   4. SPRÁVA KATEGORIÍ - renderCategories a logiku
   ======================================================== */
function updateCategorySelects() {
    const selects = [$('transactionCategory'), $('modalTCategory')];
    
    selects.forEach(select => {
        if (!select) return; 
        
        const currentSelected = select.value;
        const currentType = (select.id === 'transactionCategory' && $('transactionType')) ? $('transactionType').value : (select.id === 'modalTCategory' && $('modalTType')) ? $('modalTType').value : 'expense';
        
        select.innerHTML = '';
        
        const relevantCategories = store.categories.filter(c => c.type === currentType);

        if (relevantCategories.length === 0) {
            const opt = document.createElement('option');
            opt.value = 'Nezadáno';
            opt.textContent = 'Nezadáno';
            select.appendChild(opt);
            return;
        }

        relevantCategories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.textContent = c.name;
            select.appendChild(opt);
        });

        if (currentSelected && relevantCategories.some(c => c.name === currentSelected)) {
            select.value = currentSelected;
        } else {
            select.value = relevantCategories[0]?.name || 'Nezadáno';
        }
    });
}

// Při změně typu transakce se musí aktualizovat i kategorie
if ($('transactionType')) {
    $('transactionType').onchange = updateCategorySelects;
}

function renderCategories() {
    const list = $('categoryList');
    list.innerHTML = '';

    store.categories.forEach((cat, index) => {
        const tag = document.createElement('div');
        tag.className = `category-tag ${cat.type}`;
        tag.innerHTML = `${cat.name} <i class="fa fa-times" onclick="deleteCategory(${index}, event)"></i>`;
        list.appendChild(tag);
    });
    
    updateCategorySelects();
}

function addCategory() {
    const name = $('newCategoryName').value.trim();
    const type = $('categoryType').value;

    if (!name) {
        alert('Zadejte prosím název kategorie.');
        return;
    }
    if (store.categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
        alert('Tato kategorie již existuje.');
        return;
    }
    
    store.categories.push({ name: name, type: type });
    saveStore();
    $('newCategoryName').value = '';
    renderCategories();
}

function deleteCategory(index, event) {
    event.stopPropagation(); 

    const catToDelete = store.categories[index];

    if (['Investice', 'Nezadáno', 'Jídlo', 'Výplata', 'Nájem/Bydlení', 'Volný čas', 'Bonus'].includes(catToDelete.name)) {
        alert('Tuto výchozí/klíčovou kategorii nelze smazat.');
        return;
    }
    
    if (confirm(`Opravdu chcete smazat kategorii "${catToDelete.name}"? Všechny transakce s touto kategorií budou převedeny na "Nezadáno".`)) {
        store.transactions.forEach(t => {
            if (t.category === catToDelete.name) {
                t.category = 'Nezadáno';
            }
        });

        store.categories.splice(index, 1);
        saveStore();
        renderCategories();
        applyFilter(); 
        computeStats(); 
    }
}


/* BUDGET - přidání transakce */
function addTransaction(){
    const date = $('transactionDate').value;
    const desc = $('transactionDesc').value.trim();
    const amount = parseFloat($('transactionAmount').value);
    const type = $('transactionType').value;
    const category = $('transactionCategory').value; 
    
    if(!date || !desc || isNaN(amount) || amount <= 0){
        alert('Vyplňte prosím datum, popis a platnou kladnou částku.');
        return;
    }

    const newTransaction = {
        id: Math.random().toString(36).substring(2, 9),
        date: date,
        desc: desc,
        amount: amount, 
        type: type,
        category: category, 
    };

    store.transactions.push(newTransaction);
    saveStore();
    
    $('transactionDesc').value = '';
    $('transactionAmount').value = '';
    
    applyFilter();
    renderMonthOptions(); 
}

/* BUDGET - transakční modal */
let currentTransaction = null;

function openTransactionModal(id){
    currentTransaction = store.transactions.find(t => t.id === id);
    if(!currentTransaction) return;
    
    $('modalTransactionTitle').innerHTML = `<i class="fa fa-edit"></i> Úprava transakce: ${currentTransaction.desc}`;
    
    const updateCategorySelect = (currentType) => {
        const categorySelect = $('modalTCategory');
        categorySelect.innerHTML = '';
        const relevantCategories = store.categories.filter(c => c.type === currentType);
        
        relevantCategories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.textContent = c.name;
            categorySelect.appendChild(opt);
        });
        
        if (relevantCategories.some(c => c.name === currentTransaction.category)) {
             categorySelect.value = currentTransaction.category;
        } else {
             categorySelect.value = relevantCategories[0]?.name || 'Nezadáno'; 
        }
    };

    $('modalTDate').value = currentTransaction.date;
    $('modalTDesc').value = currentTransaction.desc;
    $('modalTAmount').value = currentTransaction.amount; 
    $('modalTType').value = currentTransaction.type;
    updateCategorySelect(currentTransaction.type); 
    
    $('modalTType').onchange = (e) => {
        const newType = e.target.value;
        updateCategorySelect(newType);
    };

    $('modalDeleteBtn').onclick = () => deleteTransaction(currentTransaction.id);
    
    $('transactionModal').style.display = 'flex';
}

function saveTransactionProfile(){
    if(!currentTransaction) return;
    
    const newType = $('modalTType').value;
    const newCategory = $('modalTCategory').value;
    
    const amount = parseFloat($('modalTAmount').value); 
    if(!$('modalTDate').value || !$('modalTDesc').value.trim() || isNaN(amount) || amount <= 0){
        alert('Vyplňte prosím datum, popis a platnou kladnou částku.');
        return;
    }
    
    currentTransaction.date = $('modalTDate').value;
    currentTransaction.desc = $('modalTDesc').value.trim();
    currentTransaction.amount = amount;
    currentTransaction.type = newType;
    currentTransaction.category = newCategory;

    saveStore();
    closeModal('transactionModal');
    applyFilter();
    computeStats();
}

function deleteTransaction(id){
    if(confirm('Opravdu chcete tuto transakci smazat?')) {
        store.transactions = store.transactions.filter(t => t.id !== id);
        saveStore();
        closeModal('transactionModal');
        applyFilter();
        computeStats();
    }
}


/* GOALS */

function addGoal(){
    const name = $('newGoalName').value.trim();
    const target = parseFloat($('newGoalTarget').value);
    const saved = parseFloat($('newGoalSaved').value) || 0; 

    if(!name || isNaN(target) || target <= 0 || isNaN(saved) || saved < 0){
        alert('Vyplňte prosím název a platnou cílovou částku.');
        return;
    }
    
    const newGoal = {
        id: Math.random().toString(36).substring(2, 9),
        name: name,
        target: target,
        saved: saved,
    };

    store.goals.push(newGoal);
    saveStore();
    
    $('newGoalName').value = '';
    $('newGoalTarget').value = '';
    $('newGoalSaved').value = '';
    
    renderGoals();
}

function renderGoals(){
    const list = $('goalsList');
    list.innerHTML = '';

    if (store.goals.length === 0) {
        list.innerHTML = '<div class="muted" style="margin-top:10px">Zatím nebyly přidány žádné cíle.</div>';
        return;
    }

    store.goals.forEach(g => {
        const percentage = g.target > 0 ? ((g.saved / g.target) * 100).toFixed(1) : 0;
        const progressWidth = Math.min(100, parseFloat(percentage)) + '%';
        const isComplete = g.saved >= g.target;

        const item = document.createElement('div');
        item.className = 'goal-item';
        item.onclick = () => openGoalModal(g.id);
        
        item.innerHTML = `
            <div class="goal-item-header">
                <div style="font-size:1.1em; font-weight:700">${g.name} ${isComplete ? '<i class="fa fa-check-circle" style="color:var(--accent2)"></i>' : ''}</div>
                <div class="badge info">${percentage}%</div>
            </div>
            <div class="goal-item-content">
                <div class="goal-item-info">
                    <div class="muted">Naspořeno: <strong>${formatAmount(g.saved)}</strong> / Cíl: ${formatAmount(g.target)}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressWidth}; background:${isComplete ? 'var(--accent)' : 'var(--accent2)'}"></div>
                    </div>
                </div>
            </div>
        `;
        list.appendChild(item);
    });
}

let currentGoal = null;

function openGoalModal(id){
    currentGoal = store.goals.find(g => g.id === id);
    if(!currentGoal) return;
    
    $('modalGoalTitle').innerHTML = `<i class="fa fa-bullseye"></i> Úprava cíle: ${currentGoal.name}`;
    
    $('modalGoalName').value = currentGoal.name;
    $('modalGoalTarget').value = currentGoal.target;
    $('modalGoalSaved').value = currentGoal.saved;
    
    $('modalInvestAmount').value = '';
    $('modalInvestDate').value = new Date().toISOString().slice(0, 10);

    $('modalGoalDeleteBtn').onclick = () => deleteGoal(currentGoal.id);
    
    $('goalModal').style.display = 'flex';
}

function saveGoalProfile(){
    if(!currentGoal) return;
    
    const target = parseFloat($('modalGoalTarget').value);
    
    if(!$('modalGoalName').value.trim() || isNaN(target) || target <= 0){
        alert('Vyplňte prosím název a platnou cílovou částku.');
        return;
    }
    
    currentGoal.name = $('modalGoalName').value.trim();
    currentGoal.target = target;
    
    saveStore();
    closeModal('goalModal');
    renderGoals();
}

function deleteGoal(id){
    if(confirm('Opravdu chcete tento investiční cíl smazat?')) {
        store.goals = store.goals.filter(g => g.id !== id);
        saveStore();
        closeModal('goalModal');
        renderGoals();
    }
}

function addInvestmentToGoal(goalId, amount, date){
    const goal = store.goals.find(g => g.id === goalId);
    if(!goal || isNaN(amount) || amount <= 0) return false;

    // 1. Přičtení k naspořené částce cíle
    goal.saved += amount;

    // 2. Vytvoření výdajové transakce (Investice)
    const newTransaction = {
        id: Math.random().toString(36).substring(2, 9),
        date: date,
        desc: `Investice do cíle: ${goal.name}`,
        amount: amount, 
        type: 'expense',
        category: 'Investice',
    };

    store.transactions.push(newTransaction);
    
    saveStore();
    return true;
}

function addInvestmentFromModal(){
    if(!currentGoal) return;

    const amount = parseFloat($('modalInvestAmount').value);
    const date = $('modalInvestDate').value;

    if (isNaN(amount) || amount <= 0 || !date) {
        alert('Zadejte prosím platnou kladnou částku a datum pro investici.');
        return;
    }
    
    if (addInvestmentToGoal(currentGoal.id, amount, date)) {
        currentGoal = store.goals.find(g => g.id === currentGoal.id); 
        $('modalGoalSaved').value = currentGoal.saved;

        alert(`Investice ${formatAmount(amount)} byla přičtena k cíli "${currentGoal.name}" a odečtena z rozpočtu.`);

        $('modalInvestAmount').value = '';
        renderGoals();
        applyFilter(); 
    } else {
        alert('Nepodařilo se přidat investici. Zkuste to znovu.');
    }
}


/* Ostatní funkce */
let currentTransactions = []; 

function renderTransactionTable(transactions){
    currentTransactions = transactions;
    const tbody = $('tableBody');
    tbody.innerHTML = '';
    let totalBalance = 0;

    transactions.forEach((t) => {
        const tr = document.createElement('tr');
        const isExpense = t.type === 'expense';
        
        const amountDisplay = t.amount; 
        
        if(isExpense) totalBalance -= amountDisplay;
        else totalBalance += amountDisplay;

        const td1 = document.createElement('td'); td1.textContent = formatDate(t.date);
        const td2 = document.createElement('td'); 
        td2.innerHTML = `<strong>${t.desc}</strong><br><span class="muted">${t.category || 'Nezadáno'}</span>`;
        
        const td3 = document.createElement('td'); 
        const badge = document.createElement('span');
        badge.className = `badge ${isExpense ? 'danger' : 'income'}`;
        badge.textContent = isExpense ? 'Výdaj' : 'Příjem';
        td3.appendChild(badge);
        
        const td4 = document.createElement('td'); td4.textContent = formatAmount(t.amount); 
        td4.style.color = isExpense ? 'var(--danger)' : 'var(--accent2)';
        td4.style.fontWeight = '700';

        const td5 = document.createElement('td');
        const editBtn = document.createElement('button');
        editBtn.className = 'btn secondary action-small';
        editBtn.innerHTML = '<i class="fa fa-edit"></i> Upravit';
        editBtn.onclick = () => openTransactionModal(t.id);
        td5.appendChild(editBtn);

        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
        tbody.appendChild(tr);
    });
    
    const balanceEl = $('totalBalance');
    balanceEl.textContent = formatAmount(totalBalance); 
    balanceEl.style.color = totalBalance >= 0 ? 'var(--accent2)' : 'var(--danger)';
    
    document.querySelector('#mainTable thead th:nth-child(4)').textContent = 'Částka (' + store.currency + ')';
}

function applyFilter(){
    const f = $('filterFrom').value ? new Date($('filterFrom').value) : new Date(0); 
    const t = $('filterTo').value ? new Date($('filterTo').value) : new Date();
    
    let filterToDate = t;
    if ($('filterTo').value) {
        filterToDate = new Date($('filterTo').value);
        filterToDate.setDate(filterToDate.getDate() + 1); 
        filterToDate.setSeconds(filterToDate.getSeconds() - 1); 
    } else {
        filterToDate.setDate(filterToDate.getDate() + 1);
        filterToDate.setSeconds(filterToDate.getSeconds() - 1);
    }
    
    let filtered = store.transactions.filter(t => {
        const date = new Date(t.date);
        return date >= f && date <= filterToDate;
    });
    
    const sel = $('sortSelect').value;
    if(sel==='date_desc'){ filtered.sort((a,b)=> new Date(b.date) - new Date(a.date)); }
    if(sel==='date_asc'){ filtered.sort((a,b)=> new Date(a.date) - new Date(b.date)); }
    if(sel==='amount_desc'){ 
        filtered.sort((a,b)=> {
            return b.amount - a.amount;
        });
    }
    
    renderTransactionTable(filtered);
    computeStats(); 
}

function applySort(){
    applyFilter(); 
}

function computeStats(){
    const f = $('filterFrom').value ? new Date($('filterFrom').value) : new Date(0);
    const t = $('filterTo').value ? new Date($('filterTo').value) : new Date();
    
    let filterToDate = t;
    if ($('filterTo').value) {
        filterToDate = new Date($('filterTo').value);
        filterToDate.setDate(filterToDate.getDate() + 1); 
        filterToDate.setSeconds(filterToDate.getSeconds() - 1); 
    } else {
        filterToDate.setDate(filterToDate.getDate() + 1);
        filterToDate.setSeconds(filterToDate.getSeconds() - 1);
    }

    let totalIncome = 0;
    let totalExpense = 0;
    const categoryTotals = {}; 

    const filtered = store.transactions.filter(t => {
        const date = new Date(t.date);
        return date >= f && date <= filterToDate;
    });

    filtered.forEach(t => {
        if(t.type === 'income'){
            totalIncome += t.amount;
        } else {
            totalExpense += t.amount;
        }
        
        const catName = t.category || 'Nezadáno';
        if(!categoryTotals[catName]){
            categoryTotals[catName] = { amount: 0, type: t.type };
        }
        categoryTotals[catName].amount += t.amount;
    });

    const totalBalance = totalIncome - totalExpense;

    $('statBalance').textContent = formatAmount(totalBalance);
    $('statBalance').style.color = totalBalance >= 0 ? 'var(--accent2)' : 'var(--danger)';
    $('statIncome').textContent = formatAmount(totalIncome);
    $('statExpense').textContent = formatAmount(totalExpense);

    const catCont = $('categoryStats'); catCont.innerHTML = '';
    const sortedCats = Object.keys(categoryTotals).map(name => ({
        name,
        ...categoryTotals[name],
    })).sort((a, b) => b.amount - a.amount);
    
    sortedCats.forEach(cat => {
        const card = document.createElement('div'); 
        card.className=`stat-card ${cat.type === 'income' ? 'income' : 'expense'}`;
        
        const total = cat.type === 'income' ? totalIncome : totalExpense;
        const percentage = total > 0 ? ((cat.amount / total) * 100).toFixed(1) : 0;

        card.innerHTML = `
            <div class="muted">${cat.name} (${cat.type === 'income' ? 'Příjem' : 'Výdaj'})</div>
            <div class="value" style="color:${cat.type === 'income' ? 'var(--accent2)' : 'var(--danger)'}">${formatAmount(cat.amount)}</div>
            <div class="muted" style="margin-top:4px; font-weight:700">${percentage}% celku</div>
        `;
        catCont.appendChild(card);
    });
}

/* ========================================================
   2. PŘEHLED MĚSÍCŮ S GRAFY - renderHistory
   ======================================================== */
function renderHistory(){
    const listCont = $('historyList');
    listCont.innerHTML = '';
    
    const today = new Date();
    const monthlyStats = {};
    let maxAmount = 0;

    // 1. Sběr dat za posledních 12 měsíců
    for (let i = 0; i < 12; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = date.getMonth();
        const key = `${year}-${month.toString().padStart(2, '0')}`;
        const monthName = ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen", "Červenec", "Srpen", "Září", "Říjen", "Listopad", "Prosinec"][month];
        
        const dateFrom = new Date(year, month, 1);
        const dateTo = new Date(year, month + 1, 0); 
        dateTo.setHours(23, 59, 59, 999); 

        let totalIncome = 0;
        let totalExpense = 0;

        store.transactions.forEach(t => {
            const tDate = new Date(t.date);
            if (tDate >= dateFrom && tDate <= dateTo) {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            }
        });

        monthlyStats[key] = {
            name: `${monthName} ${year}`,
            income: totalIncome,
            expense: totalExpense,
            balance: totalIncome - totalExpense,
        };
        maxAmount = Math.max(maxAmount, totalIncome, totalExpense);
    }
    
    // 2. Vykreslení karet s grafy
    Object.keys(monthlyStats).sort().reverse().forEach(key => {
        const stats = monthlyStats[key];
        const card = document.createElement('div');
        card.className = 'history-month-card';
        
        const balanceColor = stats.balance >= 0 ? 'var(--accent2)' : 'var(--danger)';
        
        // Výpočet výšek pro graf
        const incomeHeight = maxAmount > 0 ? (stats.income / maxAmount) * 100 : 0;
        const expenseHeight = maxAmount > 0 ? (stats.expense / maxAmount) * 100 : 0;
        
        card.innerHTML = `
            <h4>${stats.name}</h4>
            <div class="history-stat-grid">
                <div>Příjmy: <strong style="color:var(--accent2)">${formatAmount(stats.income)}</strong></div>
                <div>Výdaje: <strong style="color:var(--danger)">${formatAmount(stats.expense)}</strong></div>
                <div style="grid-column: 1 / span 2;">Bilance: <strong style="color:${balanceColor}">${formatAmount(stats.balance)}</strong></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-bar-wrap">
                    <div class="chart-bar income" style="height: ${incomeHeight}%;"></div>
                    <div class="chart-label" style="top: ${100 - incomeHeight - 5}%;">${incomeHeight > 0 ? Math.round(incomeHeight) + '%' : ''}</div>
                </div>
                <div class="chart-bar-wrap">
                    <div class="chart-bar expense" style="height: ${expenseHeight}%;"></div>
                    <div class="chart-label" style="top: ${100 - expenseHeight - 5}%;">${expenseHeight > 0 ? Math.round(expenseHeight) + '%' : ''}</div>
                </div>
            </div>
            <div class="muted" style="text-align:center; font-size:0.8em; margin-top:5px;">Příjmy / Výdaje</div>
        `;
        listCont.appendChild(card);
    });
}


function clearAll(){
    if(confirm('POZOR: Opravdu chcete smazat VŠECHNA data (transakce, cíle, kategorie)? Tato akce je nevratná.')){
        localStorage.clear();
        alert('Všechna data byla smazána.');
        window.location.reload();
    }
}

function exportAllJSON(){
    const data = JSON.stringify(store, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'financni_planovac_export_' + new Date().toISOString().slice(0, 10) + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importAllJSON(event){
    const file = event.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedStore = JSON.parse(e.target.result);
            if(confirm('Opravdu chcete importovat tato data? PŘEPÍŠÍ AKTUÁLNÍ DATA.')){
                localStorage.setItem(LS_TRANSACTIONS, JSON.stringify(importedStore.transactions || []));
                localStorage.setItem(LS_GOALS, JSON.stringify(importedStore.goals || []));
                localStorage.setItem(LS_CATEGORIES, JSON.stringify(importedStore.categories || []));
                localStorage.setItem(LS_CURRENCY, importedStore.currency || 'CZK');
                localStorage.setItem(LS_EXCHANGE_RATE, importedStore.exchangeRate || 1);
                
                alert('Data úspěšně importována. Aplikace se obnoví.');
                window.location.reload();
            }
        } catch (error) {
            alert('Chyba při nahrávání souboru. Ujistěte se, že se jedná o platný JSON soubor. Chyba: ' + error.message);
        }
    };
    reader.readAsText(file);
}

function exportCSV() {
    let csv = 'Datum;Popis;Typ;Částka (' + store.currency + ');Kategorie\n';
    currentTransactions.forEach(t => {
        const amountDisplay = t.amount; 
        csv += `${t.date};"${t.desc.replace(/"/g, '""')}";${t.type === 'income' ? 'Příjem' : 'Výdaj'};${t.amount.toString().replace('.', ',')};${t.category || 'Nezadáno'}\n`;
    });

    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' }); 
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'financni_planovac_export_transakci.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/* redraw / orchestrace */
function redrawAll(){
  loadStore();
  fetchExchangeRate(); 
  todayShort();
  
  renderMonthOptions(); 
  
  const now = new Date();
  if(!$('transactionDate').value) $('transactionDate').value = now.toISOString().slice(0,10);
  
  $('currencySelect').value = store.currency; 

  renderCategories(); 
  renderGoals(); 
  applyFilter(); 
  
  const currentTheme = document.body.getAttribute('data-theme') || 'light';
  updateThemeButton(currentTheme);
  if(currentTheme === 'dark') {
      initStarfield(); 
      startStarfield(); 
  }
}


/* theme & starfield animation - ZACHOVÁNO */
let starfieldCtx = null;
let stars = [];
let starAnimId = null;

const devicePixelRatio = window.devicePixelRatio || 1;

function initStarfield(){
  const c = document.getElementById('starfield');
  if (!c) return; 
  
  c.width = window.innerWidth * devicePixelRatio;
  c.height = window.innerHeight * devicePixelRatio;
  c.style.width = window.innerWidth + 'px';
  c.style.height = window.innerHeight + 'px';
  starfieldCtx = c.getContext('2d');
  starfieldCtx.scale(devicePixelRatio, devicePixelRatio);
  
  stars = [];
  const count = Math.round(window.innerWidth / 12);
  for(let i=0;i<count;i++){
    stars.push({
      x: Math.random() * window.innerWidth,
      y: Math.random() * window.innerHeight,
      r: Math.random() * 1.2 + 0.3,
      vx: (Math.random()-0.5)*0.02,
      vy: (Math.random()-0.5)*0.02,
      twinkle: Math.random()*1.5
    });
  }
}

function animateStarfield(time){
  if(!starfieldCtx) return;
  starfieldCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
  starfieldCtx.globalCompositeOperation = 'lighter';
  stars.forEach(s=>{
    s.x += s.vx * (1 + Math.sin(time/1000 + s.twinkle));
    s.y += s.vy * (1 + Math.cos(time/1100 + s.twinkle));
    if(s.x < 0) s.x = window.innerWidth;
    if(s.x > window.innerWidth) s.x = 0;
    if(s.y < 0) s.y = window.innerHeight;
    if(s.y > window.innerHeight) s.y = 0;
    const g = starfieldCtx.createRadialGradient(s.x, s.y, 0, s.x, s.y, s.r*6);
    g.addColorStop(0, 'rgba(255,255,255,0.95)');
    g.addColorStop(0.2, 'rgba(255,255,255,0.6)');
    g.addColorStop(1, 'rgba(255,255,255,0.0)');
    starfieldCtx.fillStyle = g;
    starfieldCtx.beginPath();
    starfieldCtx.arc(s.x, s.y, s.r*3, 0, Math.PI*2);
    starfieldCtx.fill();
  });
  starAnimId = requestAnimationFrame(animateStarfield);
}
function startStarfield(){ 
    if(!starfieldCtx) initStarfield(); 
    if(!starAnimId) starAnimId = requestAnimationFrame(animateStarfield); 
}
function stopStarfield(){ 
    if(starAnimId){ 
        cancelAnimationFrame(starAnimId); 
        starAnimId = null; 
        const c = document.getElementById('starfield'); 
        if(c && starfieldCtx){ 
            starfieldCtx.clearRect(0,0,c.width,c.height); 
        } 
    } 
}

function toggleTheme(){
  const body = document.body;
  const t = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
  body.setAttribute('data-theme', t);
  updateThemeButton(t);
  if(t === 'dark'){ 
    startStarfield(); 
  } else { 
    stopStarfield(); 
  }
}

function updateThemeButton(theme){
    const btn = $('themeBtn');
    if(!btn) return;
    if(theme === 'dark'){
        btn.innerHTML = '<i class="fa fa-sun"></i> Světlý režim';
    } else {
        btn.innerHTML = '<i class="fa fa-moon"></i> Tmavý režim';
    }
}

window.addEventListener('resize', ()=>{ 
    if(document.body.getAttribute('data-theme')==='dark'){
        initStarfield(); 
    }
});

window.addEventListener('mousemove',(e)=>{
  if(!stars || stars.length===0 || document.body.getAttribute('data-theme') === 'light') return; 
  const cx = e.clientX / window.innerWidth - 0.5;
  const cy = e.clientY / window.innerHeight - 0.5;
  stars.forEach((s,i)=>{
    s.x += cx * 0.6 * (i%3===0 ? 0.6 : 0.2);
    s.y += cy * 0.6 * (i%3===0 ? 0.6 : 0.2);
  });
});

/* init */
(function init(){
  redrawAll();
  
  const currentTheme = document.body.getAttribute('data-theme') || 'light';
  updateThemeButton(currentTheme);
  if(currentTheme === 'dark') {
      initStarfield();
      startStarfield(); 
  }
})();
</script>

</body>
</html>
